<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Estoque - Bipagem (Câmera + OCR + QR)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Leitor de QRCode / códigos de barras -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <!-- OCR de texto da etiqueta -->
  <script src="https://unpkg.com/tesseract.js@v5.0.3/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      background: #f7f7f7;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.08);
    }
    h1 {
      font-size: 20px;
      margin: 5px 0 10px;
    }
    h2 {
      font-size: 18px;
      margin: 15px 0 6px;
    }
    p {
      margin: 4px 0;
      font-size: 14px;
    }
    .small {
      font-size: 12px;
      color: #555;
    }
    input, button {
      font-size: 14px;
      padding: 6px 8px;
      margin: 3px 0;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f0f0f0;
    }
    button.primary {
      background: #007bff;
      color: #fff;
      border-color: #0066d6;
    }
    button.danger {
      background: #f44336;
      color: #fff;
      border-color: #d32f2f;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .row-actions button {
      font-size: 12px;
      padding: 2px 5px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 2fr 2fr 1fr auto;
      gap: 6px;
      align-items: center;
    }
    .ok { background: #e0ffe0; }
    .pendente { background: #fffbe0; }
    .alerta { background: #ffe0e0; }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
    }
    .badge-ok { background: #c6f6c6; }
    .badge-pendente { background: #fff2b3; }
    .badge-alerta { background: #ffc4c4; }
    .section-box {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px;
      margin-top: 8px;
      background: #fafafa;
    }
    .flex {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .flex > div {
      flex: 1;
      min-width: 220px;
    }
    #qrReader {
      width: 260px;
      max-width: 100%;
      margin-top: 5px;
    }
    #videoOcr {
      width: 260px;
      max-width: 100%;
      background: #000;
      border-radius: 4px;
    }
    #ocrText {
      white-space: pre-wrap;
      max-height: 100px;
      overflow: auto;
      background: #fff;
      border: 1px solid #ccc;
      padding: 4px;
      font-size: 11px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Controle de Estoque - Bipagem (Câmera + OCR + QR)</h1>
  <p class="small">
    • Estoque carregado a partir dos SKUs da planilha (embutidos no código).<br>
    • Bipagem via teclado/leitor, via OCR da etiqueta (<code>1. SKU *QTD</code>) e via QR code (controle de duplicidade).<br>
    • Beep sonoro para sucesso e erro.
  </p>

  <!-- 1) Adicionar / atualizar itens -->
  <h2>1) Adicionar / atualizar itens</h2>
  <p class="small">
    Se você adicionar um SKU + Cor que já existe, a quantidade esperada será atualizada (o “bipado” é mantido).
  </p>
  <div class="section-box">
    <div class="form-grid">
      <div>
        <label>SKU (planilha)</label><br>
        <input type="text" id="novoSku" placeholder="Ex: KP-7023, D-Y03, ON-FN632, TE-115...">
      </div>
      <div>
        <label>Cor (planilha)</label><br>
        <input type="text" id="novaCor" placeholder="Ex: PRETO, BCO, AZUL, ROSA, VERDE...">
      </div>
      <div>
        <label>Quantidade</label><br>
        <input type="number" id="novaQtd" value="300" min="0">
      </div>
      <div>
        <button id="btnAdicionar" class="primary">Adicionar / Atualizar</button>
      </div>
    </div>
    <div id="resumo" class="small"></div>
  </div>

  <!-- 2) Itens em estoque -->
  <h2>2) Itens em estoque</h2>
  <div class="section-box" style="max-height: 320px; overflow:auto;">
    <table>
      <thead>
      <tr>
        <th>#</th>
        <th>SKU (planilha)</th>
        <th>Cor (planilha)</th>
        <th>SKU p/ bipagem (padrão PDF)</th>
        <th>Qtd esperada</th>
        <th>Bipado</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
      </thead>
      <tbody id="tbodyItens"></tbody>
    </table>
  </div>

  <!-- 3) Bipagem via teclado/leitor -->
  <h2>3) Bipagem via leitor/teclado</h2>
  <div class="section-box">
    <p class="small">
      Deixe o campo abaixo focado e use o leitor (ou digite) o SKU:<br>
      • SKU p/ bipagem completo (ex: <code>D-Y03LARANJA (LARANJA)</code>)<br>
      • ou só o SKU da planilha (ex: <code>D-Y03</code>, <code>ON-FN632</code>, <code>TE-115</code>)<br>
      Se encontrar exatamente 1 item, soma +1 no “Bipado”.
    </p>
    <input id="campoBipagem" placeholder="Bipe / digite aqui e Enter">
    <div id="infoBipagem" class="small"></div>
  </div>

  <!-- 4) Leitura por QR code (duplicidade) -->
  <h2>4) Leitor de QR code (duplicidade de etiqueta)</h2>
  <div class="section-box">
    <p class="small">
      Usa o QR da etiqueta (aquele que hoje retorna algo como <code>BR254063667006F</code>) só para controle de duplicidade.<br>
      Se o mesmo QR for lido novamente, avisa “produto duplicado” e toca um beep de erro.<br>
      Há um intervalo mínimo de <b>5 segundos</b> entre leituras válidas para evitar repetição acidental.
    </p>
    <button id="btnQrIniciar" class="primary">Iniciar câmera QR</button>
    <button id="btnQrParar" class="danger" disabled>Parar câmera QR</button>
    <div id="qrInfo" class="small"></div>
    <div id="qrReader"></div>
  </div>

  <!-- 5) Leitura por câmera + OCR da etiqueta -->
  <h2>5) Leitura de etiqueta (OCR - SKU e quantidade)</h2>
  <div class="section-box">
    <p class="small">
      Este modo tira uma “foto” da etiqueta, roda OCR e procura linhas como:<br>
      <code>1. CS-30 *1</code>, <code>1. D-Y03LARANJA (LARANJA) *2</code><br>
      Ele extrai:<br>
      • SKU completo (entre <b>1.</b> e <b>*</b>)<br>
      • Quantidade (número após <b>*</b>)<br>
      E soma essa quantidade no item correspondente da tabela.<br><br>
      Os SKUs das etiquetas ficam logo abaixo de “SKU: 1; …” e na mesma linha do “*1”.
    </p>
    <div class="flex">
      <div>
        <video id="videoOcr" autoplay muted playsinline></video><br>
        <button id="btnOcrIniciar" class="primary">Iniciar câmera OCR</button>
        <button id="btnOcrCapturar">Capturar etiqueta (OCR)</button>
        <button id="btnOcrParar" class="danger">Parar câmera OCR</button>
        <div id="ocrStatus" class="small"></div>
      </div>
      <div>
        <b>Texto OCR bruto (debug):</b>
        <div id="ocrText"></div>
      </div>
    </div>
    <canvas id="canvasOcr" style="display:none;"></canvas>
  </div>
</div>

<script>
  // =========================
  // 0) Beep sonoro
  // =========================
  function beep(tipo) {
    try {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const duration = 0.12;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'square';
      osc.frequency.value = (tipo === 'erro') ? 220 : 880;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      gain.gain.setValueAtTime(0.12, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
      osc.start();
      osc.stop(audioCtx.currentTime + duration);
    } catch (e) {
      console.error('Erro beep:', e);
    }
  }

  // =========================
  // 1) Dados base (Planilha embutida)
  // =========================
  const itensBasePlanilha = [
    {"sku": "KP-RO826", "cor": "", "qty": 300},
    {"sku": "KP-RO852", "cor": "", "qty": 300},
    {"sku": "KP-RO832", "cor": "", "qty": 300},
    {"sku": "KP-548B", "cor": "", "qty": 300},
    {"sku": "KP-TC07", "cor": "", "qty": 300},
    {"sku": "KP-LB521", "cor": "", "qty": 300},
    {"sku": "KP-TE119", "cor": "", "qty": 300},
    {"sku": "KP-517", "cor": "", "qty": 300},
    {"sku": "KP-7023", "cor": "PRETO", "qty": 300},
    {"sku": "KP-7023", "cor": "BCO", "qty": 300},
    {"sku": "KP-7023", "cor": "AZUL", "qty": 300},
    {"sku": "KP-MU003", "cor": "", "qty": 300},
    {"sku": "KP-RO833", "cor": "", "qty": 300},
    {"sku": "KP-MU014", "cor": "", "qty": 300},
    {"sku": "KP-TE112", "cor": "PRETO", "qty": 300},
    {"sku": "KP-TE112", "cor": "VERDE", "qty": 300},
    {"sku": "KP-TE112", "cor": "ROSA", "qty": 300},
    {"sku": "KP-5816", "cor": "", "qty": 300},
    {"sku": "KP-CA127", "cor": "", "qty": 300},
    {"sku": "KP-ONFN639", "cor": "", "qty": 300},
    {"sku": "KP-ONF90", "cor": "", "qty": 300},
    {"sku": "KP-2064", "cor": "", "qty": 300},
    {"sku": "KP-TC19", "cor": "", "qty": 300},
    {"sku": "KP-TE115", "cor": "", "qty": 300},
    {"sku": "KP-TE124", "cor": "", "qty": 300},
    {"sku": "KP-6040", "cor": "", "qty": 300},
    {"sku": "KP-IM600", "cor": "", "qty": 300},
    {"sku": "KP-LBFN606", "cor": "", "qty": 300},
    {"sku": "KP-RO802", "cor": "", "qty": 300},
    {"sku": "KP-PN899", "cor": "PRETO", "qty": 300},
    {"sku": "KP-PN899", "cor": "BRANCO", "qty": 300},
    {"sku": "D-3204", "cor": "", "qty": 300},
    {"sku": "D-Y03", "cor": "AZUL", "qty": 300},
    {"sku": "D-Y03", "cor": "VERM", "qty": 300},
    {"sku": "D-Y03", "cor": "LARANJA", "qty": 300},
    {"sku": "D-Y03", "cor": "PRATA", "qty": 300},
    {"sku": "D-Y03", "cor": "PRETA", "qty": 300},
    {"sku": "D-3210", "cor": "", "qty": 300},
    {"sku": "D-F12", "cor": "", "qty": 300},
    {"sku": "D-6201", "cor": "", "qty": 300},
    {"sku": "D-P13", "cor": "", "qty": 300},
    {"sku": "D-G105", "cor": "", "qty": 300},
    {"sku": "D-3142", "cor": "", "qty": 300},
    {"sku": "D-F8", "cor": "", "qty": 300},
    {"sku": "D-F13", "cor": "", "qty": 300},
    {"sku": "D-F11", "cor": "", "qty": 300},
    {"sku": "D-F14", "cor": "", "qty": 300},
    {"sku": "D-S14", "cor": "", "qty": 300},
    {"sku": "D-S4145", "cor": "", "qty": 300},
    {"sku": "D-EM07", "cor": "", "qty": 300},
    {"sku": "D-3205", "cor": "", "qty": 300},
    {"sku": "D-4235", "cor": "", "qty": 300},
    {"sku": "D-S30", "cor": "", "qty": 300},
    {"sku": "D-BH2807", "cor": "", "qty": 300},
    {"sku": "D-4232", "cor": "", "qty": 300},
    {"sku": "D-3158", "cor": "PRETO", "qty": 300},
    {"sku": "D-3158", "cor": "AZUL", "qty": 300},
    {"sku": "D-3158", "cor": "AMARELO", "qty": 300},
    {"sku": "D-3158", "cor": "VERM", "qty": 300},
    {"sku": "D-3158", "cor": "VERDE", "qty": 300},
    {"sku": "D-BH1065", "cor": "", "qty": 300},
    {"sku": "D-BH1064", "cor": "", "qty": 300},
    {"sku": "D-BH1051", "cor": "", "qty": 300},
    {"sku": "D-BH1050", "cor": "", "qty": 300},
    {"sku": "D-BH1019", "cor": "", "qty": 300},
    {"sku": "D-1601", "cor": "", "qty": 300},
    {"sku": "D-3151", "cor": "", "qty": 300},
    {"sku": "D-Y04/05", "cor": "", "qty": 300},
    {"sku": "D-NK1201", "cor": "", "qty": 300},
    {"sku": "D-MN001", "cor": "", "qty": 300},
    {"sku": "D-TELA04", "cor": "", "qty": 300},
    {"sku": "D-TELA02", "cor": "", "qty": 300},
    {"sku": "D-AI05", "cor": "", "qty": 300},
    {"sku": "D-A24E9903", "cor": "", "qty": 300},
    {"sku": "D-AI06", "cor": "", "qty": 300},
    {"sku": "D-X338", "cor": "", "qty": 300},
    {"sku": "D-XK300", "cor": "", "qty": 300},
    {"sku": "D-S8122", "cor": "", "qty": 300},
    {"sku": "D-Y07", "cor": "", "qty": 300},
    {"sku": "D-XK101", "cor": "", "qty": 300},
    {"sku": "D-X612", "cor": "", "qty": 300},
    {"sku": "PROT. AURICULAR", "cor": "", "qty": 300},
    {"sku": "PAPABOLINHAS", "cor": "", "qty": 300},
    {"sku": "M-303", "cor": "", "qty": 300},
    {"sku": "CS-30", "cor": "", "qty": 300},
    {"sku": "RO-832", "cor": "", "qty": 300},
    {"sku": "LB-521", "cor": "", "qty": 300},
    {"sku": "FONE", "cor": "", "qty": 300},
    {"sku": "PG-9023S", "cor": "", "qty": 300},
    {"sku": "XKO01PRETO", "cor": "", "qty": 300},
    {"sku": "ON-FN632", "cor": "BRANCO", "qty": 300},
    {"sku": "ON-FN632", "cor": "ROSA", "qty": 300},
    {"sku": "ON-FN632", "cor": "VERDE", "qty": 300},
    {"sku": "ON-FN632", "cor": "ROXO", "qty": 300},
    {"sku": "ON-FN632", "cor": "AZUL", "qty": 300},
    {"sku": "TE-115", "cor": "", "qty": 300},
    {"sku": "TE-119", "cor": "", "qty": 300},
    {"sku": "TE-121", "cor": "", "qty": 300},
    {"sku": "TE-124", "cor": "", "qty": 300},
    {"sku": "PN-899", "cor": "", "qty": 300},
    {"sku": "CANETA TERMICA", "cor": "", "qty": 300},
    {"sku": "TABLET INFANTIL", "cor": "azul", "qty": 300},
    {"sku": "TABLET INFANTIL", "cor": "rosa", "qty": 300},
    {"sku": "KP-TE129", "cor": "", "qty": 300},
    {"sku": "KP-TE146", "cor": "", "qty": 300},
    {"sku": "D-TELA03", "cor": "", "qty": 300},
    {"sku": "D-TELA05", "cor": "", "qty": 300},
    {"sku": "D-TELA06", "cor": "", "qty": 300},
    {"sku": "D-TELA07", "cor": "", "qty": 300},
    {"sku": "D-BH1064", "cor": "VERMELHO", "qty": 300},
    {"sku": "D-BH1064", "cor": "PRETO", "qty": 300},
    {"sku": "D-BH1064", "cor": "ROSA", "qty": 300},
    {"sku": "D-BH1064", "cor": "PRATA", "qty": 300},
    {"sku": "D-BH1064", "cor": "ROSÉ", "qty": 300},
    {"sku": "D-BH1051", "cor": "AZUL", "qty": 300},
    {"sku": "D-BH1051", "cor": "PRETO", "qty": 300},
    {"sku": "D-BH1051", "cor": "ROSÉ", "qty": 300},
    {"sku": "D-BH1051", "cor": "ROSA", "qty": 300},
    {"sku": "D-BH1051", "cor": "VERMELHO", "qty": 300},
    {"sku": "D-BH1051", "cor": "PRATA", "qty": 300},
    {"sku": "D-BH1050", "cor": "AZUL", "qty": 300},
    {"sku": "D-BH1050", "cor": "PRETO", "qty": 300},
    {"sku": "D-BH1050", "cor": "ROSÉ", "qty": 300},
    {"sku": "D-BH1050", "cor": "PRATA", "qty": 300},
    {"sku": "AI07", "cor": "", "qty": 300},
    {"sku": "AI03", "cor": "", "qty": 300},
    {"sku": "D-BH8115", "cor": "", "qty": 300},
    {"sku": "D-238G 180H", "cor": "", "qty": 300},
    {"sku": "DS-14", "cor": "PRETO", "qty": 300},
    {"sku": "KP-397", "cor": "VERMELHO", "qty": 300},
    {"sku": "KP-FN632", "cor": "ROSA", "qty": 300},
    {"sku": "KP-FN632", "cor": "VERDE", "qty": 300},
    {"sku": "D-FT101", "cor": "", "qty": 300},
    {"sku": "DRONE", "cor": "", "qty": 300},
    {"sku": "RO802", "cor": "", "qty": 300}
  ];

  let itens = [];
  let proximoId = 1;

  const tbodyItens = document.getElementById('tbodyItens');
  const resumoDiv = document.getElementById('resumo');
  const campoBipagem = document.getElementById('campoBipagem');
  const infoBipagem = document.getElementById('infoBipagem');

  // =========================
  // 2) Normalização de texto / cor
  // =========================
  function normalizarTexto(txt) {
    if (!txt) return "";
    return txt.toString().trim().toUpperCase();
  }

  function normalizarCorCanon(cor) {
    if (!cor) return "";
    let c = cor.toString().trim().toUpperCase();

    c = c
      .replace(/[ÁÀÂÃ]/g, "A")
      .replace(/[ÉÈÊ]/g, "E")
      .replace(/[ÍÌÎ]/g, "I")
      .replace(/[ÓÒÔÕ]/g, "O")
      .replace(/[ÚÙÛ]/g, "U")
      .replace(/Ç/g, "C");

    c = c.replace(/\s+/g, " ");

    const mapa = {
      "BCO": "BRANCO",
      "BRAN": "BRANCO",
      "BRANCO": "BRANCO",
      "PRETA": "PRETO",
      "PRETO": "PRETO",
      "PT": "PRETO",
      "PTO": "PRETO",
      "AZUL": "AZUL",
      "VERDE": "VERDE",
      "VD": "VERDE",
      "ROSA": "ROSA",
      "VERM": "VERMELHO",
      "VERMELHO": "VERMELHO",
      "LARANJA": "LARANJA",
      "CINZA": "CINZA",
      "MARROM": "MARROM",
      "LILAS": "LILAS",
      "ROXO": "ROXO",
      "ROSE": "ROSE",
      "ROSEGOLD": "ROSE"
    };

    const semEspaco = c.replace(/\s+/g, "");
    if (mapa[semEspaco]) return mapa[semEspaco];
    if (mapa[c]) return mapa[c];
    return c;
  }

  function prettyCor(corCanon) {
    if (!corCanon) return "";
    return corCanon.toUpperCase();
  }

  // =========================
  // 3) Adaptar SKU -> padrão PDF (para bipagem)
  // =========================
  function adaptarSkuParaPdf(skuOriginal, corOriginal) {
    if (!skuOriginal) return "";
    const skuUp = skuOriginal.toString().trim().toUpperCase();
    const corCanon = normalizarCorCanon(corOriginal || "");
    const corPretty = prettyCor(corCanon);

    if (skuUp === "D-3204") {
      return "D-3204+MIC";
    }
    if (skuUp === "D-3210") {
      return "D-3210 (SEM MICROFONE)";
    }
    if (skuUp === "D-3158" || skuUp === "D-S3158") {
      const base = "D-S3158";
      if (corPretty) return base + " (" + corPretty + ")";
      return base;
    }
    if (skuUp === "D-Y03") {
      if (corCanon) return "D-Y03" + corCanon + " (" + corPretty + ")";
      return "D-Y03";
    }
    if (skuUp === "D-Y04" || skuUp === "D-Y05" || skuUp === "D-Y04/05") {
      let base = skuUp;
      if (corPretty) return base + " (" + corPretty + ")";
      return base;
    }
    if (skuUp === "KP-7023") {
      if (corCanon) return "KP-7023" + corCanon + " (" + corPretty + ")";
      return "KP-7023";
    }
    if (skuUp === "ON-FN632" || skuUp === "KP-FN632") {
      if (corCanon) return "ON-FN632" + corCanon + " (" + corPretty + ")";
      return "ON-FN632";
    }
    if (skuUp === "KP-TE115" || skuUp === "TE-115") {
      return "TE-115 (Tecnologia Anti-Ghost)";
    }
    if (skuUp === "KP-TE124" || skuUp === "TE-124") {
      return "TE-124 (Iluminação RGB Gamer)";
    }
    if (skuUp === "KP-TE112") {
      if (corCanon) return "KP-TE112" + corCanon + " (" + corPretty + ")";
      return "KP-TE112";
    }
    if (skuUp === "KP-LB521" || skuUp === "LB-521") {
      return "LB-521";
    }
    if (skuUp === "KP-PN899" || skuUp === "PN-899") {
      return "PN-899PD";
    }
    if (skuUp === "PROT. AURICULAR" || skuUp === "PROT AURICULAR") {
      return "PROTETOR AURICULAR";
    }
    if (skuUp === "D-MN001" || skuUp === "MONITOR D-MN001") {
      return "MONITOR D-MN001";
    }
    if (skuUp === "XKO01PRETO") {
      const corText = corPretty || "PRETO";
      return "XKO01PRETO (" + corText + ")";
    }
    if (skuUp === "CS-30") {
      return "CS-30";
    }
    if (skuUp === "RO-832") {
      return "RO-832";
    }
    if (skuUp === "PG-9023S") {
      return "PG-9023S";
    }
    if (skuUp === "M-303") {
      return "M-303";
    }
    if (skuUp === "FONE" || skuUp === "FONE LEBOSS") {
      return "FONE LEBOSS";
    }

    if (corPretty) {
      return skuUp + " (" + corPretty + ")";
    }
    return skuUp;
  }

  // =========================
  // 4) Inicialização & render
  // =========================
  function inicializarItens() {
    itens = itensBasePlanilha.map(obj => ({
      id: proximoId++,
      sku: obj.sku,
      cor: obj.cor,
      qty: obj.qty,
      bipado: 0
    }));
    renderTabela();
  }

  function renderTabela() {
    tbodyItens.innerHTML = "";
    const ordenados = [...itens].sort((a, b) => {
      const sA = a.sku.toUpperCase(), sB = b.sku.toUpperCase();
      if (sA < sB) return -1;
      if (sA > sB) return 1;
      const cA = (a.cor || "").toUpperCase(), cB = (b.cor || "").toUpperCase();
      if (cA < cB) return -1;
      if (cA > cB) return 1;
      return 0;
    });

    ordenados.forEach((item, idx) => {
      const tr = document.createElement('tr');
      const bip = item.bipado || 0;
      const esperado = Number(item.qty) || 0;

      let status = "", badgeClass = "", rowClass = "";
      if (esperado === 0 && bip === 0) {
        status = "Sem quantidade";
      } else if (bip === 0 && esperado > 0) {
        status = "Ainda não bipado";
        badgeClass = "badge-pendente";
        rowClass = "pendente";
      } else if (bip < esperado) {
        status = `Pendente (${bip}/${esperado})`;
        badgeClass = "badge-pendente";
        rowClass = "pendente";
      } else if (bip === esperado) {
        status = "OK (completo)";
        badgeClass = "badge-ok";
        rowClass = "ok";
      } else if (bip > esperado) {
        status = `Excesso (${bip}/${esperado})`;
        badgeClass = "badge-alerta";
        rowClass = "alerta";
      }
      tr.className = rowClass;

      const tdIdx = document.createElement('td'); tdIdx.textContent = idx + 1; tr.appendChild(tdIdx);
      const tdSku = document.createElement('td'); tdSku.textContent = item.sku; tr.appendChild(tdSku);
      const tdCor = document.createElement('td'); tdCor.textContent = item.cor || "-"; tr.appendChild(tdCor);
      const tdSkuPdf = document.createElement('td'); tdSkuPdf.textContent = adaptarSkuParaPdf(item.sku, item.cor); tr.appendChild(tdSkuPdf);

      const tdQtd = document.createElement('td');
      const inputQtd = document.createElement('input');
      inputQtd.type = "number"; inputQtd.min = "0";
      inputQtd.value = item.qty; inputQtd.style.width = "70px";
      inputQtd.addEventListener('change', () => {
        item.qty = Number(inputQtd.value) || 0;
        renderTabela();
      });
      tdQtd.appendChild(inputQtd);
      tr.appendChild(tdQtd);

      const tdBip = document.createElement('td'); tdBip.textContent = bip; tr.appendChild(tdBip);

      const tdStatus = document.createElement('td');
      if (status) {
        const span = document.createElement('span');
        span.textContent = status;
        span.className = "badge " + badgeClass;
        tdStatus.appendChild(span);
      }
      tr.appendChild(tdStatus);

      const tdAcoes = document.createElement('td');
      tdAcoes.className = "row-actions";
      const btnRemover = document.createElement('button');
      btnRemover.textContent = "Remover";
      btnRemover.addEventListener('click', () => removerItemPorId(item.id));
      tdAcoes.appendChild(btnRemover);
      tr.appendChild(tdAcoes);

      tbodyItens.appendChild(tr);
    });

    atualizarResumo();
  }

  function atualizarResumo() {
    const totalItens = itens.length;
    const totalQtd = itens.reduce((s, it) => s + (Number(it.qty) || 0), 0);
    const totalBip = itens.reduce((s, it) => s + (Number(it.bipado) || 0), 0);
    resumoDiv.innerHTML =
      `<b>Total de variações:</b> ${totalItens} | ` +
      `<b>Peças esperadas:</b> ${totalQtd} | ` +
      `<b>Peças bipadas:</b> ${totalBip}`;
  }

  // =========================
  // 5) Adicionar / atualizar / remover itens (manual)
  // =========================
  document.getElementById('btnAdicionar').addEventListener('click', () => {
    const sku = document.getElementById('novoSku').value.trim();
    const cor = document.getElementById('novaCor').value.trim();
    const qtd = Number(document.getElementById('novaQtd').value) || 0;
    if (!sku) {
      alert("Informe o SKU.");
      return;
    }
    adicionarOuAtualizarItem(sku, cor, qtd, true);
  });

  function adicionarOuAtualizarItem(sku, cor, qty, renderDepois) {
    const skuNorm = normalizarTexto(sku);
    const corNorm = normalizarTexto(cor);
    let itemExistente = itens.find(it =>
      normalizarTexto(it.sku) === skuNorm &&
      normalizarTexto(it.cor) === corNorm
    );
    if (itemExistente) {
      itemExistente.qty = qty;
    } else {
      itens.push({
        id: proximoId++,
        sku: sku,
        cor: cor,
        qty: qty,
        bipado: 0
      });
    }
    if (renderDepois) {
      renderTabela();
      document.getElementById('novoSku').value = "";
      document.getElementById('novaCor').value = "";
      document.getElementById('novaQtd').value = 300;
    }
  }

  function removerItemPorId(id) {
    itens = itens.filter(it => it.id !== id);
    renderTabela();
  }

  // =========================
  // 6) Bipagem via campo (teclado/leitor)
  // =========================
  campoBipagem.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const valor = campoBipagem.value.trim();
      if (!valor) return;
      processarEntradaSimples(valor);
      campoBipagem.value = "";
    }
  });

  function processarEntradaSimples(texto) {
    const codUp = texto.trim().toUpperCase();
    // Tentar casar SKU p/ bipagem
    let candidatos = itens.filter(it =>
      adaptarSkuParaPdf(it.sku, it.cor).toUpperCase() === codUp
    );
    if (candidatos.length === 0) {
      // tentar casar pelo sku da planilha
      candidatos = itens.filter(it => it.sku.toUpperCase() === codUp);
    }
    if (candidatos.length === 0) {
      infoBipagem.textContent = `⚠ SKU/código não encontrado: "${texto}"`;
      beep('erro');
      return;
    }
    if (candidatos.length > 1) {
      infoBipagem.textContent = `⚠ Código "${texto}" corresponde a mais de um item (ambíguo).`;
      beep('erro');
      return;
    }
    const item = candidatos[0];
    item.bipado = (item.bipado || 0) + 1;
    atualizarStatusBipagemDisplay(item, 1);
    renderTabela();
  }

  function atualizarStatusBipagemDisplay(item, qtdAdicionada) {
    const esperado = Number(item.qty) || 0;
    const bip = item.bipado;
    let msg;
    if (bip > esperado && esperado > 0) {
      msg = `ALERTA: "${adaptarSkuParaPdf(item.sku, item.cor)}" bipado ${bip}x, esperado ${esperado}. Pode ser duplicado.`;
      beep('erro');
    } else if (bip === esperado && esperado > 0) {
      msg = `OK: "${adaptarSkuParaPdf(item.sku, item.cor)}" atingiu ${bip}/${esperado}.`;
      beep('ok');
    } else {
      msg = `PENDENTE: "${adaptarSkuParaPdf(item.sku, item.cor)}" bipado ${bip}/${esperado} (acréscimo +${qtdAdicionada}).`;
      beep('ok');
    }
    infoBipagem.textContent = msg;
  }

  // =========================
  // 7) QR code - duplicidade com timer
  // =========================
  let html5QrCode = null;
  let qrCameraAtiva = false;
  let codigosQrLidos = new Set();
  let ultimaLeituraQr = 0;
  const intervaloQrMs = 5000; // 5 segundos

  const btnQrIniciar = document.getElementById('btnQrIniciar');
  const btnQrParar = document.getElementById('btnQrParar');
  const qrInfo = document.getElementById('qrInfo');

  btnQrIniciar.addEventListener('click', iniciarCameraQr);
  btnQrParar.addEventListener('click', pararCameraQr);

  function iniciarCameraQr() {
    if (qrCameraAtiva) return;
    if (!window.Html5Qrcode) {
      alert("Biblioteca html5-qrcode não carregada.");
      return;
    }
    qrInfo.textContent = "Abrindo câmera para ler QR...";
    html5QrCode = new Html5Qrcode("qrReader");
    const config = { fps: 10, qrbox: { width: 220, height: 220 } };

    html5QrCode.start(
      { facingMode: "environment" },
      config,
      (decodedText) => {
        const agora = Date.now();
        if (agora - ultimaLeituraQr < intervaloQrMs) {
          // Ignora leituras muito próximas (evita repetição)
          return;
        }
        ultimaLeituraQr = agora;
        processarQr(decodedText);
      },
      (errorMsg) => {
        // erros de leitura são normais; não exibir para não poluir a interface
      }
    ).then(() => {
      qrCameraAtiva = true;
      qrInfo.textContent = "Câmera QR ativa. Aponte para o QR da etiqueta.";
      btnQrIniciar.disabled = true;
      btnQrParar.disabled = false;
    }).catch(err => {
      console.error(err);
      qrInfo.textContent = "Não foi possível abrir a câmera QR: " + err;
      qrCameraAtiva = false;
    });
  }

  function pararCameraQr() {
    if (!html5QrCode || !qrCameraAtiva) return;
    html5QrCode.stop().then(() => {
      html5QrCode.clear();
      qrCameraAtiva = false;
      qrInfo.textContent = "Câmera QR parada.";
      btnQrIniciar.disabled = false;
      btnQrParar.disabled = true;
    }).catch(err => {
      console.error(err);
      qrInfo.textContent = "Erro ao parar câmera QR: " + err;
    });
  }

  function processarQr(texto) {
    const cod = texto.trim();
    if (!cod) return;
    if (codigosQrLidos.has(cod)) {
      qrInfo.textContent = `⚠ Produto duplicado! QR já lido: ${cod}`;
      beep('erro');
    } else {
      codigosQrLidos.add(cod);
      qrInfo.textContent = `OK: QR registrado: ${cod} (total lidos: ${codigosQrLidos.size})`;
      beep('ok');
    }
  }

  // =========================
  // 8) OCR da etiqueta (SKU + quantidade)
  // =========================
  const videoOcr = document.getElementById('videoOcr');
  const canvasOcr = document.getElementById('canvasOcr');
  const ocrTextDiv = document.getElementById('ocrText');
  const ocrStatus = document.getElementById('ocrStatus');

  const btnOcrIniciar = document.getElementById('btnOcrIniciar');
  const btnOcrCapturar = document.getElementById('btnOcrCapturar');
  const btnOcrParar = document.getElementById('btnOcrParar');

  let streamOcr = null;

  btnOcrIniciar.addEventListener('click', iniciarCameraOcr);
  btnOcrParar.addEventListener('click', pararCameraOcr);
  btnOcrCapturar.addEventListener('click', capturarEtiquetaOcr);

  async function iniciarCameraOcr() {
    try {
      if (streamOcr) return;
      ocrStatus.textContent = "Solicitando acesso à câmera...";
      const constraints = {
        video: { facingMode: "environment" }
      };
      streamOcr = await navigator.mediaDevices.getUserMedia(constraints);
      videoOcr.srcObject = streamOcr;
      ocrStatus.textContent = "Câmera OCR ativa. Centralize a etiqueta e clique em 'Capturar etiqueta (OCR)'.";
    } catch (e) {
      console.error(e);
      ocrStatus.textContent = "Não foi possível abrir a câmera OCR: " + e;
    }
  }

  function pararCameraOcr() {
    if (streamOcr) {
      streamOcr.getTracks().forEach(t => t.stop());
      streamOcr = null;
      videoOcr.srcObject = null;
      ocrStatus.textContent = "Câmera OCR parada.";
    }
  }

  function capturarEtiquetaOcr() {
    if (!streamOcr) {
      ocrStatus.textContent = "Ative a câmera OCR antes de capturar.";
      return;
    }
    const video = videoOcr;
    const canvas = canvasOcr;
    const ctx = canvas.getContext('2d');

    // Define o canvas do tamanho do vídeo
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    ocrStatus.textContent = "Processando OCR (pode demorar alguns segundos)...";

    Tesseract.recognize(canvas, 'por', { logger: m => {} })
      .then(result => {
        const texto = result.data.text || "";
        ocrTextDiv.textContent = texto;
        ocrStatus.textContent = "OCR concluído. Tentando localizar SKU e quantidade...";
        processarTextoEtiqueta(texto);
      })
      .catch(err => {
        console.error(err);
        ocrStatus.textContent = "Erro no OCR: " + err;
      });
  }

  // Processa o texto OCR, procurando linhas tipo: 1. D-Y03LARANJA (LARANJA) *2
  function processarTextoEtiqueta(texto) {
    if (!texto) {
      ocrStatus.textContent = "Nenhum texto reconhecido na etiqueta.";
      beep('erro');
      return;
    }

    const linhasEncontradas = [];
    const regexLinha = /1\.\s*(.+?)\s*\*([\d]+)/g; // captura entre "1." e "*" + quantidade
    let match;
    while ((match = regexLinha.exec(texto)) !== null) {
      const skuBruto = match[1].replace(/\s+/g, " ").trim();
      const qtdStr = match[2];
      const qtd = parseInt(qtdStr, 10) || 0;
      if (!skuBruto || !qtd) continue;
      linhasEncontradas.push({ sku: skuBruto, qtd });
    }

    if (linhasEncontradas.length === 0) {
      ocrStatus.textContent = "Não consegui encontrar padrão '1. SKU *QTD' no texto.";
      beep('erro');
      return;
    }

    let resumo = "";
    linhasEncontradas.forEach(info => {
      const ok = registrarSkuEQuantidade(info.sku, info.qtd);
      resumo += (ok ? "OK" : "ERRO") + ` - ${info.sku} *${info.qtd}\n`;
    });

    ocrStatus.textContent = "Resultado OCR processado:\n" + resumo.trim();
  }

  // Recebe o SKU completo (como na etiqueta) e a quantidade e aplica no estoque
  function registrarSkuEQuantidade(skuEtiqueta, quantidade) {
    const codUp = skuEtiqueta.toUpperCase().trim();

    // 1º tentativa: casar com SKU p/ bipagem exato
    let candidatos = itens.filter(it =>
      adaptarSkuParaPdf(it.sku, it.cor).toUpperCase() === codUp
    );

    // 2º tentativa: se não achar, tenta se a etiqueta começa com o SKU da planilha
    if (candidatos.length === 0) {
      candidatos = itens.filter(it => {
        const skuPlan = it.sku.toUpperCase();
        return codUp.startsWith(skuPlan);
      });
    }

    if (candidatos.length === 0) {
      ocrStatus.textContent += `\n⚠ SKU da etiqueta não encontrado na tabela: "${skuEtiqueta}"`;
      beep('erro');
      return false;
    }
    if (candidatos.length > 1) {
      ocrStatus.textContent += `\n⚠ SKU "${skuEtiqueta}" corresponde a mais de um item (ambíguo).`;
      beep('erro');
      return false;
    }

    const item = candidatos[0];
    item.bipado = (item.bipado || 0) + quantidade;
    atualizarStatusBipagemDisplay(item, quantidade);
    renderTabela();
    return true;
  }

  // =========================
  // 9) Inicializar tudo
  // =========================
  inicializarItens();
</script>
</body>
</html>
