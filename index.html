<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Estoque - PDF + QR Duplicidade</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bibliotecas locais (precisam estar na mesma pasta do HTML) -->
  <script src="pdf.min.js"></script>
  <script src="html5-qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      background: #f7f7f7;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    h1, h2 {
      font-size: 20px;
      margin: 10px 0;
    }
    p {
      margin: 6px 0;
      font-size: 14px;
    }
    input, button {
      font-size: 14px;
      padding: 6px 8px;
      margin: 3px 0;
    }
    input[type="text"], input[type="number"], input[type="file"] {
      width: 100%;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #e9e9e9;
    }
    button.primary {
      background: #4caf50;
      color: #fff;
      border-color: #4caf50;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
    .row-actions button {
      font-size: 11px;
      padding: 3px 6px;
    }
    @media (min-width: 600px) {
      .form-grid {
        display: grid;
        grid-template-columns: 2fr 2fr 1fr auto;
        gap: 6px;
        align-items: center;
      }
      .form-grid-qr {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 6px;
        align-items: center;
      }
    }
    .ok {
      background: #e0ffe0;
    }
    .alerta {
      background: #ffe0e0;
    }
    .pendente {
      background: #fffbe0;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
    }
    .badge-ok {
      background: #c6f6c6;
    }
    .badge-alerta {
      background: #ffc4c4;
    }
    .badge-pendente {
      background: #fff2b3;
    }
    #reader {
      width: 260px;
      max-width: 100%;
      margin-top: 8px;
    }
    .log {
      max-height: 160px;
      overflow-y: auto;
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 6px;
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Controle de Estoque - PDF + QR Duplicidade</h1>

  <p class="small">
    • Os SKUs da planilha estão carregados com estoque inicial (ajustável).<br>
    • <b>PDF</b>: lê as etiquetas (linha com <code>1. ... *QTD</code>) e abate estoque pelo SKU + quantidade.<br>
    • <b>QR-Code da etiqueta</b>: usado só para controle de duplicidade (se já foi lido, avisa).<br>
  </p>

  <!-- 1) Estoque -->
  <h2>1) Tabela de estoque</h2>
  <p class="small">
    Você pode ajustar manualmente o estoque atual ou adicionar/remover SKUs.
  </p>

  <div class="form-grid">
    <div>
      <label>SKU (planilha)</label><br>
      <input type="text" id="novoSku" placeholder="Ex: D-Y03, KP-7023, ON-FN632...">
    </div>
    <div>
      <label>Cor (planilha)</label><br>
      <input type="text" id="novaCor" placeholder="Ex: PRETO, AZUL, ROSA...">
    </div>
    <div>
      <label>Estoque inicial</label><br>
      <input type="number" id="novaQtd" value="300" min="0">
    </div>
    <div>
      <button id="btnAdicionar" class="primary">Adicionar / Atualizar SKU</button>
    </div>
  </div>

  <div id="resumo"></div>

  <div style="max-height: 280px; overflow:auto; margin-top:5px;">
    <table id="tabelaItens">
      <thead>
        <tr>
          <th>#</th>
          <th>SKU (planilha)</th>
          <th>Cor</th>
          <th>SKU etiqueta (padrão PDF)</th>
          <th>Estoque atual</th>
          <th>Saída (lida)</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyItens"></tbody>
    </table>
  </div>

  <!-- 2) Leitura de etiquetas via PDF -->
  <h2>2) Ler etiquetas (PDF) para abater estoque</h2>
  <p class="small">
    Selecione um ou mais PDFs com as etiquetas (<b>MEGA EXPLOSAO</b>).<br>
    O sistema procura linhas no formato <code>1. SKU COMPLETO *QTD</code>, por exemplo:<br>
    <code>1. CS-30 *1</code><br>
    <code>1. D-Y03LARANJA (LARANJA) *2</code><br>
    e usa o que estiver entre <b>1.</b> e <b>*</b> como SKU da etiqueta, e o número depois de <b>*</b> como quantidade.
  </p>
  <input type="file" id="pdfInput" accept="application/pdf" multiple>
  <button id="btnLerPDF" class="primary">Processar PDFs</button>
  <div id="infoPDF" class="small"></div>
  <div id="logPDF" class="log"></div>

  <!-- 3) QR-Code para controle de duplicidade -->
  <h2>3) Leitor de QR-Code (controle de duplicidade)</h2>
  <p class="small">
    Use a câmera para ler o QR-Code da etiqueta (Shopee / Correios).<br>
    • Se o código de rastreio for lido pela primeira vez → OK.<br>
    • Se já tiver sido lido antes → avisa <b>“Produto duplicado”</b>.<br>
    Há um intervalo de <b>5 segundos</b> entre leituras válidas para evitar repetição automática.
  </p>

  <div class="form-grid-qr">
    <div>
      <button id="btnIniciarQR" class="primary">Iniciar câmera (QR)</button>
      <button id="btnPararQR">Parar câmera</button>
    </div>
    <div>
      <span id="statusQR" class="small"></span>
    </div>
  </div>

  <div id="reader"></div>
  <div id="logQR" class="log"></div>
</div>

<script>
  // =========================
  // CONFIGURAÇÃO PDF.JS LOCAL
  // =========================
  if (window['pdfjsLib']) {
    // Ajuste o nome do worker se o arquivo tiver outro nome (ex: pdf.worker.js)
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.min.js';
  }

  // =========================
  // 1) DADOS BASE (planilha)
  // =========================

  // Modelo dos SKUs da sua planilha (mesma lógica que usamos antes).
  // Você pode acrescentar mais linhas conforme necessário.
  const itensBasePlanilha = [
    {"sku": "KP-RO826", "cor": "", "qty": 300},
    {"sku": "KP-RO852", "cor": "", "qty": 300},
    {"sku": "KP-RO832", "cor": "", "qty": 300},
    {"sku": "KP-548B", "cor": "", "qty": 300},
    {"sku": "KP-TC07", "cor": "", "qty": 300},
    {"sku": "KP-LB521", "cor": "", "qty": 300},
    {"sku": "KP-TE119", "cor": "", "qty": 300},
    {"sku": "KP-517", "cor": "", "qty": 300},
    {"sku": "KP-7023", "cor": "PRETO", "qty": 300},
    {"sku": "KP-7023", "cor": "BCO", "qty": 300},
    {"sku": "KP-7023", "cor": "AZUL", "qty": 300},
    {"sku": "KP-MU003", "cor": "", "qty": 300},
    {"sku": "KP-RO833", "cor": "", "qty": 300},
    {"sku": "KP-MU014", "cor": "", "qty": 300},
    {"sku": "KP-TE112", "cor": "PRETO", "qty": 300},
    {"sku": "KP-TE112", "cor": "VERDE", "qty": 300},
    {"sku": "KP-TE112", "cor": "ROSA", "qty": 300},
    {"sku": "KP-5816", "cor": "", "qty": 300},
    {"sku": "KP-CA127", "cor": "", "qty": 300},
    {"sku": "KP-ONFN639", "cor": "", "qty": 300},
    {"sku": "KP-ONF90", "cor": "", "qty": 300},
    {"sku": "KP-2064", "cor": "", "qty": 300},
    {"sku": "KP-TC19", "cor": "", "qty": 300},
    {"sku": "KP-TE115", "cor": "", "qty": 300},
    {"sku": "KP-TE124", "cor": "", "qty": 300},
    {"sku": "KP-6040", "cor": "", "qty": 300},
    {"sku": "KP-IM600", "cor": "", "qty": 300},
    {"sku": "KP-LBFN606", "cor": "", "qty": 300},
    {"sku": "KP-RO802", "cor": "", "qty": 300},
    {"sku": "KP-PN899", "cor": "PRETO", "qty": 300},
    {"sku": "KP-PN899", "cor": "BRANCO", "qty": 300},
    {"sku": "D-3204", "cor": "", "qty": 300},
    {"sku": "D-Y03", "cor": "AZUL", "qty": 300},
    {"sku": "D-Y03", "cor": "VERM", "qty": 300},
    {"sku": "D-Y03", "cor": "LARANJA", "qty": 300},
    {"sku": "D-Y03", "cor": "PRATA", "qty": 300},
    {"sku": "D-Y03", "cor": "PRETA", "qty": 300},
    {"sku": "D-3210", "cor": "", "qty": 300},
    {"sku": "D-F12", "cor": "", "qty": 300},
    {"sku": "D-6201", "cor": "", "qty": 300},
    {"sku": "D-P13", "cor": "", "qty": 300},
    {"sku": "D-G105", "cor": "", "qty": 300},
    {"sku": "D-3142", "cor": "", "qty": 300},
    {"sku": "D-F8", "cor": "", "qty": 300},
    {"sku": "D-F13", "cor": "", "qty": 300},
    {"sku": "D-F11", "cor": "", "qty": 300},
    {"sku": "D-F14", "cor": "", "qty": 300},
    {"sku": "D-S14", "cor": "", "qty": 300},
    {"sku": "D-S4145", "cor": "", "qty": 300},
    {"sku": "D-EM07", "cor": "", "qty": 300},
    {"sku": "D-3205", "cor": "", "qty": 300},
    {"sku": "D-4235", "cor": "", "qty": 300},
    {"sku": "D-S30", "cor": "", "qty": 300},
    {"sku": "D-BH2807", "cor": "", "qty": 300},
    {"sku": "D-4232", "cor": "", "qty": 300},
    {"sku": "D-3158", "cor": "PRETO", "qty": 300},
    {"sku": "D-3158", "cor": "AZUL", "qty": 300},
    {"sku": "D-3158", "cor": "AMARELO", "qty": 300},
    {"sku": "D-3158", "cor": "VERM", "qty": 300},
    {"sku": "D-3158", "cor": "VERDE", "qty": 300},
    {"sku": "D-1601", "cor": "", "qty": 300},
    {"sku": "D-MN001", "cor": "", "qty": 300},
    {"sku": "CS-30", "cor": "", "qty": 300},
    {"sku": "RO-832", "cor": "", "qty": 300},
    {"sku": "LB-521", "cor": "", "qty": 300},
    {"sku": "FONE", "cor": "", "qty": 300},
    {"sku": "PG-9023S", "cor": "", "qty": 300},
    {"sku": "XKO01PRETO", "cor": "", "qty": 300},
    {"sku": "ON-FN632", "cor": "BRANCO", "qty": 300},
    {"sku": "ON-FN632", "cor": "ROSA", "qty": 300},
    {"sku": "ON-FN632", "cor": "VERDE", "qty": 300},
    {"sku": "ON-FN632", "cor": "ROXO", "qty": 300},
    {"sku": "ON-FN632", "cor": "AZUL", "qty": 300},
    {"sku": "TE-115", "cor": "", "qty": 300},
    {"sku": "TE-124", "cor": "", "qty": 300},
    {"sku": "PN-899", "cor": "", "qty": 300}
    // ... se quiser, adicione o restante da planilha aqui
  ];

  let itens = []; // {id, sku, cor, estoqueInicial, estoqueAtual, saida, skuEtiqueta, skuEtiquetaNorm}
  let proximoId = 1;

  const tbodyItens = document.getElementById('tbodyItens');
  const resumoDiv = document.getElementById('resumo');
  const infoPDF = document.getElementById('infoPDF');
  const logPDF = document.getElementById('logPDF');

  // =========================
  // FUNÇÕES DE APOIO
  // =========================

  function beep(tipo) {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g);
      g.connect(ctx.destination);

      if (tipo === 'ok') {
        o.frequency.value = 880;
      } else if (tipo === 'dup') {
        o.frequency.value = 220;
      } else {
        o.frequency.value = 440;
      }

      o.type = 'square';
      g.gain.setValueAtTime(0.1, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.2);
      o.start();
      o.stop(ctx.currentTime + 0.2);
    } catch (e) {
      // em alguns navegadores pode falhar; ignora
    }
  }

  function normalizarTexto(txt) {
    if (!txt) return "";
    return txt.toString().trim().toUpperCase().replace(/\s+/g, " ");
  }

  function normalizarCorCanon(cor) {
    if (!cor) return "";
    let c = cor.toString().trim().toUpperCase();
    c = c
      .replace(/[ÁÀÂÃ]/g, "A")
      .replace(/[ÉÈÊ]/g, "E")
      .replace(/[ÍÌÎ]/g, "I")
      .replace(/[ÓÒÔÕ]/g, "O")
      .replace(/[ÚÙÛ]/g, "U")
      .replace(/Ç/g, "C");
    c = c.replace(/\s+/g, " ");

    const mapa = {
      "BCO": "BRANCO",
      "BRAN": "BRANCO",
      "BRANCO": "BRANCO",
      "PRETA": "PRETO",
      "PRETO": "PRETO",
      "PT": "PRETO",
      "PTO": "PRETO",
      "AZUL": "AZUL",
      "VERDE": "VERDE",
      "VD": "VERDE",
      "ROSA": "ROSA",
      "VERM": "VERMELHO",
      "VERMELHO": "VERMELHO",
      "LARANJA": "LARANJA",
      "CINZA": "CINZA",
      "MARROM": "MARROM",
      "LILAS": "LILAS",
      "ROXO": "ROXO",
      "ROSE": "ROSE",
      "ROSEGOLD": "ROSE",
      "ROSÉ": "ROSE"
    };

    const semEspaco = c.replace(/\s+/g, "");
    if (mapa[semEspaco]) return mapa[semEspaco];
    if (mapa[c]) return mapa[c];
    return c;
  }

  function prettyCor(corCanon) {
    if (!corCanon) return "";
    return corCanon.toUpperCase();
  }

  // Adapta SKU planilha + cor para o formato das etiquetas (padrão PDF)
  function adaptarSkuParaEtiqueta(skuOriginal, corOriginal) {
    if (!skuOriginal) return "";
    const skuUp = skuOriginal.toString().trim().toUpperCase();
    const corCanon = normalizarCorCanon(corOriginal || "");
    const corPretty = prettyCor(corCanon);

    if (skuUp === "D-3204") {
      return "D-3204+MIC";
    }
    if (skuUp === "D-3210") {
      return "D-3210 (SEM MICROFONE)";
    }
    if (skuUp === "D-3158" || skuUp === "D-S3158") {
      const base = "D-S3158";
      if (corPretty) return base + " (" + corPretty + ")";
      return base;
    }
    if (skuUp === "D-Y03") {
      if (corCanon) return "D-Y03" + corCanon + " (" + corPretty + ")";
      return "D-Y03";
    }
    if (skuUp === "D-Y04" || skuUp === "D-Y05" || skuUp === "D-Y04/05") {
      let base = skuUp;
      if (corPretty) return base + " (" + corPretty + ")";
      return base;
    }
    if (skuUp === "KP-7023") {
      if (corCanon) return "KP-7023" + corCanon + " (" + corPretty + ")";
      return "KP-7023";
    }
    if (skuUp === "ON-FN632" || skuUp === "KP-FN632") {
      if (corCanon) return "ON-FN632" + corCanon + " (" + corPretty + ")";
      return "ON-FN632";
    }
    if (skuUp === "KP-TE115" || skuUp === "TE-115") {
      return "TE-115 (Tecnologia Anti-Ghost)";
    }
    if (skuUp === "KP-TE124" || skuUp === "TE-124") {
      return "TE-124 (Iluminação RGB Gamer)";
    }
    if (skuUp === "KP-TE112") {
      if (corCanon) {
        return "KP-TE112" + corCanon + " (" + corPretty + ")";
      }
      return "KP-TE112";
    }
    if (skuUp === "KP-LB521" || skuUp === "LB-521") {
      return "LB-521";
    }
    if (skuUp === "KP-PN899" || skuUp === "PN-899") {
      return "PN-899PD";
    }
    if (skuUp === "PROT. AURICULAR" || skuUp === "PROT AURICULAR") {
      return "PROTETOR AURICULAR";
    }
    if (skuUp === "D-MN001" || skuUp === "MONITOR D-MN001") {
      return "MONITOR D-MN001";
    }
    if (skuUp === "XKO01PRETO") {
      const corText = corPretty || "PRETO";
      return "XKO01PRETO (" + corText + ")";
    }
    if (skuUp === "CS-30") {
      return "CS-30";
    }
    if (skuUp === "RO-832") {
      return "RO-832";
    }
    if (skuUp === "PG-9023S") {
      return "PG-9023S";
    }
    if (skuUp === "M-303") {
      return "M-303";
    }
    if (skuUp === "FONE" || skuUp === "FONE LEBOSS") {
      return "FONE LEBOSS";
    }

    if (corPretty) {
      return skuUp + " (" + corPretty + ")";
    }
    return skuUp;
  }

  function inicializarItens() {
    itens = itensBasePlanilha.map(obj => {
      const skuEtiqueta = adaptarSkuParaEtiqueta(obj.sku, obj.cor);
      const skuEtiquetaNorm = normalizarTexto(skuEtiqueta);
      const estoqueInicial = obj.qty || 0;
      return {
        id: proximoId++,
        sku: obj.sku,
        cor: obj.cor,
        estoqueInicial: estoqueInicial,
        estoqueAtual: estoqueInicial,
        saida: 0,
        skuEtiqueta: skuEtiqueta,
        skuEtiquetaNorm: skuEtiquetaNorm
      };
    });
    renderTabela();
  }

  function encontrarItemPorSkuEtiqueta(skuEtiquetaBruto) {
    const norm = normalizarTexto(skuEtiquetaBruto);
    let candidatos = itens.filter(it => it.skuEtiquetaNorm === norm);
    if (candidatos.length === 1) return candidatos[0];

    // fallback: começa com / contém
    candidatos = itens.filter(it =>
      it.skuEtiquetaNorm.startsWith(norm) ||
      norm.startsWith(it.skuEtiquetaNorm)
    );
    if (candidatos.length === 1) return candidatos[0];

    return null;
  }

  function renderTabela() {
    tbodyItens.innerHTML = "";
    const ordenados = [...itens].sort((a, b) => {
      const sA = a.sku.toUpperCase();
      const sB = b.sku.toUpperCase();
      if (sA < sB) return -1;
      if (sA > sB) return 1;
      const cA = (a.cor || "").toUpperCase();
      const cB = (b.cor || "").toUpperCase();
      if (cA < cB) return -1;
      if (cA > cB) return 1;
      return 0;
    });

    ordenados.forEach((item, index) => {
      const tr = document.createElement('tr');

      // status
      let cls = "";
      let statusTxt = "";
      let badgeCls = "";
      if (item.estoqueAtual === 0 && item.saida === 0) {
        statusTxt = "Sem movimentação";
        badgeCls = "badge-pendente";
        cls = "pendente";
      } else if (item.estoqueAtual < 0) {
        statusTxt = "Estoque negativo";
        badgeCls = "badge-alerta";
        cls = "alerta";
      } else if (item.saida > 0) {
        statusTxt = "Com saídas";
        badgeCls = "badge-ok";
        cls = "ok";
      }

      tr.className = cls;

      const tdIdx = document.createElement('td');
      tdIdx.textContent = index + 1;
      tr.appendChild(tdIdx);

      const tdSku = document.createElement('td');
      tdSku.textContent = item.sku;
      tr.appendChild(tdSku);

      const tdCor = document.createElement('td');
      tdCor.textContent = item.cor || "-";
      tr.appendChild(tdCor);

      const tdEtiqueta = document.createElement('td');
      tdEtiqueta.textContent = item.skuEtiqueta;
      tr.appendChild(tdEtiqueta);

      const tdEstoque = document.createElement('td');
      const inpEst = document.createElement('input');
      inpEst.type = "number";
      inpEst.style.width = "80px";
      inpEst.value = item.estoqueAtual;
      inpEst.addEventListener('change', () => {
        item.estoqueAtual = Number(inpEst.value) || 0;
        atualizarResumo();
      });
      tdEstoque.appendChild(inpEst);
      tr.appendChild(tdEstoque);

      const tdSaida = document.createElement('td');
      tdSaida.textContent = item.saida;
      tr.appendChild(tdSaida);

      const tdStatus = document.createElement('td');
      if (statusTxt) {
        const span = document.createElement('span');
        span.textContent = statusTxt;
        span.className = "badge " + badgeCls;
        tdStatus.appendChild(span);
      }
      tr.appendChild(tdStatus);

      const tdAcoes = document.createElement('td');
      tdAcoes.className = "row-actions";
      const btnRem = document.createElement('button');
      btnRem.textContent = "Remover";
      btnRem.addEventListener('click', () => {
        itens = itens.filter(it => it.id !== item.id);
        renderTabela();
      });
      tdAcoes.appendChild(btnRem);
      tr.appendChild(tdAcoes);

      tbodyItens.appendChild(tr);
    });

    atualizarResumo();
  }

  function atualizarResumo() {
    const totalItens = itens.length;
    const totalEstoque = itens.reduce((s, it) => s + (Number(it.estoqueAtual) || 0), 0);
    const totalSaida = itens.reduce((s, it) => s + (Number(it.saida) || 0), 0);
    resumoDiv.innerHTML =
      `<p><b>Variações cadastradas:</b> ${totalItens}<br>` +
      `<b>Estoque atual (soma):</b> ${totalEstoque}<br>` +
      `<b>Saída total (lidas em PDF):</b> ${totalSaida}</p>`;
  }

  function adicionarOuAtualizarItem(sku, cor, estoqueInicial) {
    const skuNorm = normalizarTexto(sku);
    const corNorm = normalizarTexto(cor);
    let item = itens.find(it =>
      normalizarTexto(it.sku) === skuNorm &&
      normalizarTexto(it.cor) === corNorm
    );
    const skuEtiqueta = adaptarSkuParaEtiqueta(sku, cor);
    const skuEtiquetaNorm = normalizarTexto(skuEtiqueta);

    if (item) {
      const diferenca = (estoqueInicial - item.estoqueInicial);
      item.estoqueInicial = estoqueInicial;
      item.estoqueAtual += diferenca; // ajusta saldo mantendo saídas
      item.skuEtiqueta = skuEtiqueta;
      item.skuEtiquetaNorm = skuEtiquetaNorm;
    } else {
      itens.push({
        id: proximoId++,
        sku: sku,
        cor: cor,
        estoqueInicial: estoqueInicial,
        estoqueAtual: estoqueInicial,
        saida: 0,
        skuEtiqueta: skuEtiqueta,
        skuEtiquetaNorm: skuEtiquetaNorm
      });
    }
    renderTabela();
  }

  document.getElementById('btnAdicionar').addEventListener('click', () => {
    const sku = document.getElementById('novoSku').value.trim();
    const cor = document.getElementById('novaCor').value.trim();
    const qtd = Number(document.getElementById('novaQtd').value) || 0;
    if (!sku) {
      alert("Informe o SKU.");
      return;
    }
    adicionarOuAtualizarItem(sku, cor, qtd);
    document.getElementById('novoSku').value = "";
    document.getElementById('novaCor').value = "";
    document.getElementById('novaQtd').value = 300;
  });

  // =========================
  // 2) LEITURA DE PDF
  // =========================

  const pdfInput = document.getElementById('pdfInput');
  const btnLerPDF = document.getElementById('btnLerPDF');

  btnLerPDF.addEventListener('click', async () => {
    const files = pdfInput.files;
    if (!files || !files.length) {
      alert("Selecione pelo menos um PDF.");
      return;
    }
    if (!window['pdfjsLib']) {
      alert("pdf.js não está carregado. Verifique se pdf.min.js está na mesma pasta.");
      return;
    }

    infoPDF.textContent = "Lendo PDFs, aguarde...";
    logPDF.textContent = "";
    let totalEtiquetas = 0;
    let totalSaida = 0;

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let textoCompleto = "";

      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        const strings = content.items.map(it => it.str);
        textoCompleto += strings.join("\n") + "\n";
      }

      // Processar texto do PDF
      const resultado = processarTextoEtiquetas(textoCompleto, file.name);
      totalEtiquetas += resultado.qtdEtiquetas;
      totalSaida += resultado.qtdTotalSaida;
    }

    infoPDF.textContent =
      `Leitura concluída. Etiquetas lidas: ${totalEtiquetas}, peças abatidas: ${totalSaida}.`;
    renderTabela();
  });

  function processarTextoEtiquetas(texto, nomeArquivo) {
    // Estratégia:
    // - percorrer linha a linha
    // - guardar o último código de rastreio (#XXXXX) encontrado
    // - quando achar linha com "1." e "*", extrair SKU + quantidade
    //   Ex: "1. CS-30 *1"  -> SKU etiqueta: "CS-30", qtd: 1
    const linhas = texto.split(/\r?\n/);
    let ultimoRastreio = null;
    let qtdEtiquetas = 0;
    let qtdTotalSaida = 0;

    logPDF.textContent += `=== Arquivo: ${nomeArquivo} ===\n`;

    for (let i = 0; i < linhas.length; i++) {
      const linha = linhas[i].trim();
      if (!linha) continue;

      // Atualiza código de rastreio (linha com "#UP2F..." ou similar)
      if (linha.includes("#")) {
        const mR = linha.match(/#([A-Z0-9]+)/);
        if (mR) {
          ultimoRastreio = mR[1];
        }
      }

      // Linha da etiqueta com "1. ... *QTD"
      if (linha.startsWith("1.") && linha.includes("*")) {
        const m = linha.match(/1\.\s*(.+?)\s*\*([0-9]+)/);
        if (!m) continue;

        const skuEtiqueta = m[1].trim();      // texto entre 1. e *
        const qtd = parseInt(m[2], 10) || 0;  // número depois do *

        qtdEtiquetas++;
        qtdTotalSaida += qtd;

        const item = encontrarItemPorSkuEtiqueta(skuEtiqueta);

        if (!item) {
          logPDF.textContent +=
            `Etiqueta: "${skuEtiqueta}" (qtd: ${qtd}) - NÃO ENCONTRADO no estoque. Rastreio: ${ultimoRastreio || "-"}\n`;
          beep('erro');
        } else {
          item.saida += qtd;
          item.estoqueAtual -= qtd;
          logPDF.textContent +=
            `Etiqueta: "${skuEtiqueta}" (qtd: ${qtd}) - OK. Rastreio: ${ultimoRastreio || "-"}\n`;
          beep('ok');
        }
      }
    }

    logPDF.textContent += `\n`;
    return { qtdEtiquetas, qtdTotalSaida };
  }

  // =========================
  // 3) QR-CODE (DUPLICIDADE)
  // =========================

  let html5QrCode = null;
  let podeLerQR = true;
  const codigosLidos = new Set();
  const statusQR = document.getElementById('statusQR');
  const logQR = document.getElementById('logQR');
  const btnIniciarQR = document.getElementById('btnIniciarQR');
  const btnPararQR = document.getElementById('btnPararQR');

  btnIniciarQR.addEventListener('click', async () => {
    if (!window['Html5Qrcode']) {
      alert("html5-qrcode não está carregado. Verifique se html5-qrcode.min.js está na mesma pasta.");
      return;
    }
    if (html5QrCode) {
      statusQR.textContent = "Câmera já ativa.";
      return;
    }

    html5QrCode = new Html5Qrcode("reader");
    statusQR.textContent = "Abrindo câmera...";

    const config = { fps: 10, qrbox: { width: 220, height: 220 } };
    podeLerQR = true;

    html5QrCode.start(
      { facingMode: "environment" },
      config,
      (decodedText, decodedResult) => {
        if (!podeLerQR) return;
        podeLerQR = false;

        const codigo = decodedText.trim();
        const jaLido = codigosLidos.has(codigo);

        if (!jaLido) {
          codigosLidos.add(codigo);
          logQR.textContent += `NOVO: ${codigo}\n`;
          statusQR.textContent = `QR lido: ${codigo} (novo)`;
          beep('ok');
        } else {
          logQR.textContent += `DUPLICADO: ${codigo}\n`;
          statusQR.textContent = `QR lido: ${codigo} (DUPLICADO)`;
          beep('dup');
        }

        // Libera próxima leitura após 5 segundos
        setTimeout(() => {
          podeLerQR = true;
        }, 5000);
      },
      (errorMessage) => {
        // erros contínuos de leitura (normal), então não mostramos nada
      }
    ).then(() => {
      statusQR.textContent = "Câmera ativa. Aponte para o QR-Code.";
    }).catch(err => {
      console.error(err);
      statusQR.textContent = "Não foi possível iniciar a câmera: " + err;
      html5QrCode = null;
    });
  });

  btnPararQR.addEventListener('click', async () => {
    if (html5QrCode) {
      try {
        await html5QrCode.stop();
        await html5QrCode.clear();
      } catch (e) {
        console.error(e);
      }
      html5QrCode = null;
      statusQR.textContent = "Câmera parada.";
    }
  });

  // Inicializa
  inicializarItens();
</script>
</body>
</html>
