<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Estoque por Etiquetas PDF (SKU + Quantidade + Rastreamento)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- pdf.js – carrega a biblioteca antes de usar pdfjsLib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.min.js"></script>
  <script>
    // Configura o worker da pdf.js para evitar erro de GlobalWorkerOptions
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.worker.min.js";
    }
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      background: #f7f7f7;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
    }
    h1, h2 {
      font-size: 20px;
      margin: 10px 0;
    }
    p {
      margin: 6px 0;
      font-size: 14px;
    }
    input, button {
      font-size: 14px;
      padding: 6px 8px;
      margin: 3px 0;
    }
    input[type="text"], input[type="number"], input[type="file"] {
      width: 100%;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #e9f3ff;
    }
    button:hover {
      background: #d7e7ff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
    .row-actions button {
      font-size: 12px;
      padding: 3px 6px;
    }
    @media (min-width: 600px) {
      .form-grid {
        display: grid;
        grid-template-columns: 2fr 2fr 1fr auto;
        gap: 6px;
        align-items: center;
      }
    }
    .ok {
      background: #e0ffe0;
    }
    .pendente {
      background: #fffbe0;
    }
    .alerta {
      background: #ffe0e0;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
    }
    .badge-ok {
      background: #c6f6c6;
    }
    .badge-pendente {
      background: #fff2b3;
    }
    .badge-alerta {
      background: #ffc4c4;
    }
    .badge-dup {
      background: #ffb3d9;
    }
    .log {
      max-height: 260px;
      overflow: auto;
      border: 1px solid #ddd;
      padding: 4px;
      background: #fafafa;
      font-size: 12px;
    }
    .log-entry-ok { color: #1f7a1f; }
    .log-entry-dup { color: #b30059; }
    .log-entry-erro { color: #b30000; }
  </style>
</head>
<body>
<div class="container">
  <h1>Controle de Estoque via Etiquetas PDF (SKU + Qtde + Rastreamento)</h1>

  <p class="small">
    Fluxo:<br>
    1) Os SKUs + cores da planilha já estão embutidos (padrão usado nas etiquetas).<br>
    2) Você faz <b>upload dos PDFs</b> das etiquetas (MEGA EXPLOSÃO etc).<br>
    3) O sistema lê o texto do PDF, procura linhas do tipo <code>1. CS-30 *1</code>, extrai <b>SKU + quantidade</b> e
       também o <b>código de rastreio</b> na linha <code>SKU: 1; Total Items: 1; #UP2F...</code>.<br>
    4) Se encontrar o SKU na tabela, soma no “Bipado” e mostra se o pedido está OK, pendente ou em excesso.<br>
    5) Se o código de rastreio já tiver sido lido antes, marca como <b>Duplicado</b> e toca um bip diferente.
  </p>

  <!-- 1) Upload de PDFs das etiquetas -->
  <h2>1) Upload de PDFs com etiquetas</h2>
  <input type="file" id="inputPDF" accept="application/pdf" multiple>
  <button id="btnProcessarPDFs">Processar PDFs</button>
  <div id="infoPDF" class="small"></div>

  <hr>

  <!-- 2) Adicionar / atualizar itens manualmente -->
  <h2>2) Adicionar / atualizar itens manualmente</h2>
  <p class="small">
    Os SKUs da planilha já estão embutidos. Se você adicionar um SKU de etiqueta que já existe,
    a quantidade esperada será atualizada (o bipado continua).
  </p>

  <div class="form-grid">
    <div>
      <label>SKU (planilha) / base</label><br>
      <input type="text" id="novoSku" placeholder="Ex: D-Y03, ON-FN632, TE-115...">
    </div>
    <div>
      <label>Cor (planilha)</label><br>
      <input type="text" id="novaCor" placeholder="Ex: PRETO, AZUL, ROSA...">
    </div>
    <div>
      <label>Quantidade esperada</label><br>
      <input type="number" id="novaQtd" value="300" min="0">
    </div>
    <div>
      <button id="btnAdicionar">Adicionar / Atualizar</button>
    </div>
  </div>

  <div id="resumo"></div>

  <!-- 3) Tabela de estoque -->
  <h2>3) Itens de estoque (planilha + embutidos)</h2>
  <div style="max-height: 330px; overflow: auto;">
    <table id="tabelaItens">
      <thead>
      <tr>
        <th>#</th>
        <th>SKU base</th>
        <th>Cor base</th>
        <th>SKU etiqueta (padrão PDF)</th>
        <th>Qtd esperada</th>
        <th>Bipado</th>
        <th>Restante</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
      </thead>
      <tbody id="tbodyItens"></tbody>
    </table>
  </div>

  <!-- 4) Log de etiquetas lidas -->
  <h2>4) Log de etiquetas lidas (PDF)</h2>
  <div class="log" id="logEtiquetas"></div>
</div>

<script>
  // =========================
  // 0) Beeps (som de bip)
  // =========================
  function tocarBeepSucesso() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "square";
      osc.frequency.value = 900;
      osc.connect(gain);
      gain.connect(ctx.destination);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      osc.start();
      osc.stop(ctx.currentTime + 0.15);
    } catch (e) {
      // se der erro, ignora (navegador bloqueou)
    }
  }

  function tocarBeepErro() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "square";
      osc.frequency.value = 300;
      osc.connect(gain);
      gain.connect(ctx.destination);
      gain.gain.setValueAtTime(0.15, ctx.currentTime);
      osc.start();
      osc.stop(ctx.currentTime + 0.25);
    } catch (e) {}
  }

  // =========================
  // 1) Base de itens (planilha)
  // =========================

  // Mesma ideia do código anterior: SKU base + cor + qty
  const itensBasePlanilha = [
    {"sku": "KP-RO826", "cor": "", "qty": 300},
    {"sku": "KP-RO852", "cor": "", "qty": 300},
    {"sku": "KP-RO832", "cor": "", "qty": 300},
    {"sku": "KP-548B", "cor": "", "qty": 300},
    {"sku": "KP-TC07", "cor": "", "qty": 300},
    {"sku": "KP-LB521", "cor": "", "qty": 300},
    {"sku": "KP-TE119", "cor": "", "qty": 300},
    {"sku": "KP-517", "cor": "", "qty": 300},
    {"sku": "KP-7023", "cor": "PRETO", "qty": 300},
    {"sku": "KP-7023", "cor": "BCO", "qty": 300},
    {"sku": "KP-7023", "cor": "AZUL", "qty": 300},
    {"sku": "KP-MU003", "cor": "", "qty": 300},
    {"sku": "KP-RO833", "cor": "", "qty": 300},
    {"sku": "KP-MU014", "cor": "", "qty": 300},
    {"sku": "KP-TE112", "cor": "PRETO", "qty": 300},
    {"sku": "KP-TE112", "cor": "VERDE", "qty": 300},
    {"sku": "KP-TE112", "cor": "ROSA", "qty": 300},
    {"sku": "KP-5816", "cor": "", "qty": 300},
    {"sku": "KP-CA127", "cor": "", "qty": 300},
    {"sku": "KP-ONFN639", "cor": "", "qty": 300},
    {"sku": "KP-ONF90", "cor": "", "qty": 300},
    {"sku": "KP-2064", "cor": "", "qty": 300},
    {"sku": "KP-TC19", "cor": "", "qty": 300},
    {"sku": "KP-TE115", "cor": "", "qty": 300},
    {"sku": "KP-TE124", "cor": "", "qty": 300},
    {"sku": "KP-6040", "cor": "", "qty": 300},
    {"sku": "KP-IM600", "cor": "", "qty": 300},
    {"sku": "KP-LBFN606", "cor": "", "qty": 300},
    {"sku": "KP-RO802", "cor": "", "qty": 300},
    {"sku": "KP-PN899", "cor": "PRETO", "qty": 300},
    {"sku": "KP-PN899", "cor": "BRANCO", "qty": 300},
    {"sku": "D-3204", "cor": "", "qty": 300},
    {"sku": "D-Y03", "cor": "AZUL", "qty": 300},
    {"sku": "D-Y03", "cor": "VERM", "qty": 300},
    {"sku": "D-Y03", "cor": "LARANJA", "qty": 300},
    {"sku": "D-Y03", "cor": "PRATA", "qty": 300},
    {"sku": "D-Y03", "cor": "PRETA", "qty": 300},
    {"sku": "D-3210", "cor": "", "qty": 300},
    {"sku": "D-F12", "cor": "", "qty": 300},
    {"sku": "D-6201", "cor": "", "qty": 300},
    {"sku": "D-P13", "cor": "", "qty": 300},
    {"sku": "D-G105", "cor": "", "qty": 300},
    {"sku": "D-3142", "cor": "", "qty": 300},
    {"sku": "D-F8", "cor": "", "qty": 300},
    {"sku": "D-F13", "cor": "", "qty": 300},
    {"sku": "D-F11", "cor": "", "qty": 300},
    {"sku": "D-F14", "cor": "", "qty": 300},
    {"sku": "D-S14", "cor": "", "qty": 300},
    {"sku": "D-S4145", "cor": "", "qty": 300},
    {"sku": "D-EM07", "cor": "", "qty": 300},
    {"sku": "D-3205", "cor": "", "qty": 300},
    {"sku": "D-4235", "cor": "", "qty": 300},
    {"sku": "D-S30", "cor": "", "qty": 300},
    {"sku": "D-BH2807", "cor": "", "qty": 300},
    {"sku": "D-4232", "cor": "", "qty": 300},
    {"sku": "D-3158", "cor": "PRETO", "qty": 300},
    {"sku": "D-3158", "cor": "AZUL", "qty": 300},
    {"sku": "D-3158", "cor": "AMARELO", "qty": 300},
    {"sku": "D-3158", "cor": "VERM", "qty": 300},
    {"sku": "D-3158", "cor": "VERDE", "qty": 300},
    {"sku": "D-BH1065", "cor": "", "qty": 300},
    {"sku": "D-BH1064", "cor": "", "qty": 300},
    {"sku": "D-BH1051", "cor": "", "qty": 300},
    {"sku": "D-BH1050", "cor": "", "qty": 300},
    {"sku": "D-BH1019", "cor": "", "qty": 300},
    {"sku": "D-1601", "cor": "", "qty": 300},
    {"sku": "D-3151", "cor": "", "qty": 300},
    {"sku": "D-Y04/05", "cor": "", "qty": 300},
    {"sku": "D-NK1201", "cor": "", "qty": 300},
    {"sku": "D-MN001", "cor": "", "qty": 300},
    {"sku": "D-TELA04", "cor": "", "qty": 300},
    {"sku": "D-TELA02", "cor": "", "qty": 300},
    {"sku": "D-AI05", "cor": "", "qty": 300},
    {"sku": "D-A24E9903", "cor": "", "qty": 300},
    {"sku": "D-AI06", "cor": "", "qty": 300},
    {"sku": "D-X338", "cor": "", "qty": 300},
    {"sku": "D-XK300", "cor": "", "qty": 300},
    {"sku": "D-S8122", "cor": "", "qty": 300},
    {"sku": "D-Y07", "cor": "", "qty": 300},
    {"sku": "D-XK101", "cor": "", "qty": 300},
    {"sku": "D-X612", "cor": "", "qty": 300},
    {"sku": "PROT. AURICULAR", "cor": "", "qty": 300},
    {"sku": "PAPABOLINHAS", "cor": "", "qty": 300},
    {"sku": "M-303", "cor": "", "qty": 300},
    {"sku": "CS-30", "cor": "", "qty": 300},
    {"sku": "RO-832", "cor": "", "qty": 300},
    {"sku": "LB-521", "cor": "", "qty": 300},
    {"sku": "FONE", "cor": "", "qty": 300},
    {"sku": "PG-9023S", "cor": "", "qty": 300},
    {"sku": "XKO01PRETO", "cor": "", "qty": 300},
    {"sku": "ON-FN632", "cor": "BRANCO", "qty": 300},
    {"sku": "ON-FN632", "cor": "ROSA", "qty": 300},
    {"sku": "ON-FN632", "cor": "VERDE", "qty": 300},
    {"sku": "ON-FN632", "cor": "ROXO", "qty": 300},
    {"sku": "ON-FN632", "cor": "AZUL", "qty": 300},
    {"sku": "TE-115", "cor": "", "qty": 300},
    {"sku": "TE-119", "cor": "", "qty": 300},
    {"sku": "TE-121", "cor": "", "qty": 300},
    {"sku": "TE-124", "cor": "", "qty": 300},
    {"sku": "PN-899", "cor": "", "qty": 300},
    {"sku": "CANETA TERMICA", "cor": "", "qty": 300},
    {"sku": "TABLET INFANTIL", "cor": "azul", "qty": 300},
    {"sku": "TABLET INFANTIL", "cor": "rosa", "qty": 300},
    {"sku": "KP-TE129", "cor": "", "qty": 300},
    {"sku": "KP-TE146", "cor": "", "qty": 300},
    {"sku": "D-TELA03", "cor": "", "qty": 300},
    {"sku": "D-TELA05", "cor": "", "qty": 300},
    {"sku": "D-TELA06", "cor": "", "qty": 300},
    {"sku": "D-TELA07", "cor": "", "qty": 300},
    {"sku": "D-BH1064", "cor": "VERMELHO", "qty": 300},
    {"sku": "D-BH1064", "cor": "PRETO", "qty": 300},
    {"sku": "D-BH1064", "cor": "ROSA", "qty": 300},
    {"sku": "D-BH1064", "cor": "PRATA", "qty": 300},
    {"sku": "D-BH1064", "cor": "ROSÉ", "qty": 300},
    {"sku": "D-BH1051", "cor": "AZUL", "qty": 300},
    {"sku": "D-BH1051", "cor": "PRETO", "qty": 300},
    {"sku": "D-BH1051", "cor": "ROSÉ", "qty": 300},
    {"sku": "D-BH1051", "cor": "ROSA", "qty": 300},
    {"sku": "D-BH1051", "cor": "VERMELHO", "qty": 300},
    {"sku": "D-BH1051", "cor": "PRATA", "qty": 300},
    {"sku": "D-BH1050", "cor": "AZUL", "qty": 300},
    {"sku": "D-BH1050", "cor": "PRETO", "qty": 300},
    {"sku": "D-BH1050", "cor": "ROSÉ", "qty": 300},
    {"sku": "D-BH1050", "cor": "PRATA", "qty": 300},
    {"sku": "AI07", "cor": "", "qty": 300},
    {"sku": "AI03", "cor": "", "qty": 300},
    {"sku": "D-BH8115", "cor": "", "qty": 300},
    {"sku": "D-238G 180H", "cor": "", "qty": 300},
    {"sku": "DS-14", "cor": "PRETO", "qty": 300},
    {"sku": "KP-397", "cor": "VERMELHO", "qty": 300},
    {"sku": "KP-FN632", "cor": "ROSA", "qty": 300},
    {"sku": "KP-FN632", "cor": "VERDE", "qty": 300},
    {"sku": "D-FT101", "cor": "", "qty": 300},
    {"sku": "DRONE", "cor": "", "qty": 300},
    {"sku": "RO802", "cor": "", "qty": 300}
  ];

  let itens = [];   // {id, skuBase, corBase, skuEtiqueta, qtyEsperada, bipado}
  let proximoId = 1;

  const tbodyItens = document.getElementById('tbodyItens');
  const resumoDiv = document.getElementById('resumo');
  const logEtiquetas = document.getElementById('logEtiquetas');
  const infoPDF = document.getElementById('infoPDF');

  // Set de códigos de rastreio já lidos para detectar duplicidade
  const codigosRastreioLidos = new Set();

  // =========================
  // 2) Normalização de cor e texto
  // =========================
  function normalizarCorCanon(cor) {
    if (!cor) return "";
    let c = cor.toString().trim().toUpperCase();

    c = c
      .replace(/[ÁÀÂÃ]/g, "A")
      .replace(/[ÉÈÊ]/g, "E")
      .replace(/[ÍÌÎ]/g, "I")
      .replace(/[ÓÒÔÕ]/g, "O")
      .replace(/[ÚÙÛ]/g, "U")
      .replace(/Ç/g, "C");

    c = c.replace(/\s+/g, " ");

    const mapa = {
      "BCO": "BRANCO",
      "BRAN": "BRANCO",
      "BRANCO": "BRANCO",
      "PRETA": "PRETO",
      "PRETO": "PRETO",
      "PT": "PRETO",
      "PTO": "PRETO",
      "AZUL": "AZUL",
      "VERDE": "VERDE",
      "VD": "VERDE",
      "ROSA": "ROSA",
      "VERM": "VERMELHO",
      "VERMELHO": "VERMELHO",
      "LARANJA": "LARANJA",
      "CINZA": "CINZA",
      "MARROM": "MARROM",
      "LILAS": "LILAS",
      "ROXO": "ROXO",
      "ROSE": "ROSE",
      "ROSEGOLD": "ROSE",
      "ROSÉ": "ROSE"
    };

    const semEspaco = c.replace(/\s+/g, "");
    if (mapa[semEspaco]) return mapa[semEspaco];
    if (mapa[c]) return mapa[c];

    return c;
  }

  function prettyCor(corCanon) {
    if (!corCanon) return "";
    return corCanon.toUpperCase();
  }

  function normalizarTexto(txt) {
    if (!txt) return "";
    return txt.toString().trim().toUpperCase();
  }

  // =========================
  // 3) Adaptar SKU base -> SKU de etiqueta (padrão PDF)
  // =========================
  function adaptarSkuParaPdf(skuOriginal, corOriginal) {
    if (!skuOriginal) return "";
    const skuUp = skuOriginal.toString().trim().toUpperCase();
    const corCanon = normalizarCorCanon(corOriginal || "");
    const corPretty = prettyCor(corCanon);

    if (skuUp === "D-3204") {
      return "D-3204+MIC";
    }
    if (skuUp === "D-3210") {
      return "D-3210 (SEM MICROFONE)";
    }
    if (skuUp === "D-3158" || skuUp === "D-S3158") {
      const base = "D-S3158";
      if (corPretty) return base + " (" + corPretty + ")";
      return base;
    }
    if (skuUp === "D-Y03") {
      if (corCanon) return "D-Y03" + corCanon + " (" + corPretty + ")";
      return "D-Y03";
    }
    if (skuUp === "D-Y04" || skuUp === "D-Y05" || skuUp === "D-Y04/05") {
      let base = skuUp;
      if (corPretty) return base + " (" + corPretty + ")";
      return base;
    }
    if (skuUp === "KP-7023") {
      if (corCanon) return "KP-7023" + corCanon + " (" + corPretty + ")";
      return "KP-7023";
    }
    if (skuUp === "ON-FN632" || skuUp === "KP-FN632") {
      if (corCanon) return "ON-FN632" + corCanon + " (" + corPretty + ")";
      return "ON-FN632";
    }
    if (skuUp === "KP-TE115" || skuUp === "TE-115") {
      return "TE-115 (Tecnologia Anti-Ghost)";
    }
    if (skuUp === "KP-TE124" || skuUp === "TE-124") {
      return "TE-124 (Iluminação RGB Gamer)";
    }
    if (skuUp === "KP-TE112") {
      if (corCanon) return "KP-TE112" + corCanon + " (" + corPretty + ")";
      return "KP-TE112";
    }
    if (skuUp === "KP-LB521" || skuUp === "LB-521") {
      return "LB-521";
    }
    if (skuUp === "KP-PN899" || skuUp === "PN-899") {
      return "PN-899PD";
    }
    if (skuUp === "PROT. AURICULAR" || skuUp === "PROT AURICULAR") {
      return "PROTETOR AURICULAR";
    }
    if (skuUp === "D-MN001" || skuUp === "MONITOR D-MN001") {
      return "MONITOR D-MN001";
    }
    if (skuUp === "XKO01PRETO") {
      const corText = corPretty || "PRETO";
      return "XKO01PRETO (" + corText + ")";
    }
    if (skuUp === "CS-30") {
      return "CS-30";
    }
    if (skuUp === "RO-832") {
      return "RO-832";
    }
    if (skuUp === "PG-9023S") {
      return "PG-9023S";
    }
    if (skuUp === "M-303") {
      return "M-303";
    }
    if (skuUp === "FONE" || skuUp === "FONE LEBOSS") {
      return "FONE LEBOSS";
    }

    if (corPretty) {
      return skuUp + " (" + corPretty + ")";
    }
    return skuUp;
  }

  // =========================
  // 4) Inicializar itens com a planilha embutida
  // =========================
  function inicializarItens() {
    itens = itensBasePlanilha.map(obj => ({
      id: proximoId++,
      skuBase: obj.sku,
      corBase: obj.cor,
      skuEtiqueta: adaptarSkuParaPdf(obj.sku, obj.cor),
      qty: obj.qty,
      bipado: 0
    }));
    renderTabela();
  }

  // =========================
  // 5) Renderização da tabela de estoque
  // =========================
  function renderTabela() {
    tbodyItens.innerHTML = "";

    const ordenados = [...itens].sort((a, b) => {
      const sA = a.skuBase.toUpperCase();
      const sB = b.skuBase.toUpperCase();
      if (sA < sB) return -1;
      if (sA > sB) return 1;
      const cA = (a.corBase || "").toUpperCase();
      const cB = (b.corBase || "").toUpperCase();
      if (cA < cB) return -1;
      if (cA > cB) return 1;
      return 0;
    });

    ordenados.forEach((item, index) => {
      const tr = document.createElement('tr');

      const bip = item.bipado || 0;
      const esperado = Number(item.qty) || 0;
      const restante = Math.max(esperado - bip, 0);

      let status = "";
      let badgeClass = "";
      let rowClass = "";

      if (esperado === 0 && bip === 0) {
        status = "Sem quantidade";
      } else if (bip === 0 && esperado > 0) {
        status = "Ainda não bipado";
        badgeClass = "badge-pendente";
        rowClass = "pendente";
      } else if (bip < esperado) {
        status = `Pendente (${bip}/${esperado})`;
        badgeClass = "badge-pendente";
        rowClass = "pendente";
      } else if (bip === esperado) {
        status = "OK (completo)";
        badgeClass = "badge-ok";
        rowClass = "ok";
      } else if (bip > esperado) {
        status = `Excesso (${bip}/${esperado})`;
        badgeClass = "badge-alerta";
        rowClass = "alerta";
      }

      tr.className = rowClass;

      const tdIdx = document.createElement('td');
      tdIdx.textContent = index + 1;
      tr.appendChild(tdIdx);

      const tdSku = document.createElement('td');
      tdSku.textContent = item.skuBase;
      tr.appendChild(tdSku);

      const tdCor = document.createElement('td');
      tdCor.textContent = item.corBase || "-";
      tr.appendChild(tdCor);

      const tdSkuEt = document.createElement('td');
      tdSkuEt.textContent = item.skuEtiqueta;
      tr.appendChild(tdSkuEt);

      const tdQtd = document.createElement('td');
      const inputQtd = document.createElement('input');
      inputQtd.type = "number";
      inputQtd.min = "0";
      inputQtd.value = item.qty;
      inputQtd.style.width = "80px";
      inputQtd.addEventListener('change', () => {
        item.qty = Number(inputQtd.value) || 0;
        renderTabela();
      });
      tdQtd.appendChild(inputQtd);
      tr.appendChild(tdQtd);

      const tdBip = document.createElement('td');
      tdBip.textContent = bip;
      tr.appendChild(tdBip);

      const tdRest = document.createElement('td');
      tdRest.textContent = restante;
      tr.appendChild(tdRest);

      const tdStatus = document.createElement('td');
      if (status) {
        const span = document.createElement('span');
        span.textContent = status;
        span.className = "badge " + badgeClass;
        tdStatus.appendChild(span);
      }
      tr.appendChild(tdStatus);

      const tdAcoes = document.createElement('td');
      tdAcoes.className = "row-actions";
      const btnRemover = document.createElement('button');
      btnRemover.textContent = "Remover";
      btnRemover.addEventListener('click', () => {
        removerItemPorId(item.id);
      });
      tdAcoes.appendChild(btnRemover);
      tr.appendChild(tdAcoes);

      tbodyItens.appendChild(tr);
    });

    atualizarResumo();
  }

  function atualizarResumo() {
    const totalItens = itens.length;
    const totalQtd = itens.reduce((s, it) => s + (Number(it.qty) || 0), 0);
    const totalBip = itens.reduce((s, it) => s + (Number(it.bipado) || 0), 0);
    const totalRest = itens.reduce((s, it) => s + Math.max((Number(it.qty) || 0) - (Number(it.bipado) || 0), 0), 0);

    resumoDiv.innerHTML =
      `<p><b>Total de variações (linhas):</b> ${totalItens}<br>` +
      `<b>Total de peças (quantidade esperada):</b> ${totalQtd}<br>` +
      `<b>Total de peças bipadas:</b> ${totalBip}<br>` +
      `<b>Total de peças restantes:</b> ${totalRest}</p>`;
  }

  // =========================
  // 6) Adicionar / atualizar / remover manualmente
  // =========================
  document.getElementById('btnAdicionar').addEventListener('click', function() {
    const sku = document.getElementById('novoSku').value.trim();
    const cor = document.getElementById('novaCor').value.trim();
    const qtd = Number(document.getElementById('novaQtd').value) || 0;

    if (!sku) {
      alert("Informe o SKU base.");
      return;
    }

    adicionarOuAtualizarItemBase(sku, cor, qtd, true);
  });

  function adicionarOuAtualizarItemBase(skuBase, corBase, qty, renderDepois) {
    const skuNorm = normalizarTexto(skuBase);
    const corNorm = normalizarTexto(corBase);

    let itemExistente = itens.find(it =>
      normalizarTexto(it.skuBase) === skuNorm &&
      normalizarTexto(it.corBase) === corNorm
    );

    if (itemExistente) {
      itemExistente.qty = qty;
    } else {
      itens.push({
        id: proximoId++,
        skuBase: skuBase,
        corBase: corBase,
        skuEtiqueta: adaptarSkuParaPdf(skuBase, corBase),
        qty: qty,
        bipado: 0
      });
    }

    if (renderDepois) {
      renderTabela();
      document.getElementById('novoSku').value = "";
      document.getElementById('novaCor').value = "";
      document.getElementById('novaQtd').value = 300;
    }
  }

  function removerItemPorId(id) {
    itens = itens.filter(it => it.id !== id);
    renderTabela();
  }

  // =========================
  // 7) Log de etiquetas
  // =========================
  function adicionarLogEntrada(tipo, mensagem) {
    const div = document.createElement('div');
    div.textContent = mensagem;
    if (tipo === 'ok') div.className = 'log-entry-ok';
    else if (tipo === 'dup') div.className = 'log-entry-dup';
    else if (tipo === 'erro') div.className = 'log-entry-erro';
    logEtiquetas.prepend(div); // mais recente em cima
  }

  // =========================
  // 8) Processamento dos PDFs (pdf.js)
  // =========================
  const inputPDF = document.getElementById('inputPDF');
  const btnProcessarPDFs = document.getElementById('btnProcessarPDFs');

  btnProcessarPDFs.addEventListener('click', async function() {
    const files = inputPDF.files;
    if (!files || files.length === 0) {
      alert("Selecione pelo menos um PDF de etiquetas.");
      return;
    }

    if (!window['pdfjsLib']) {
      alert("pdf.js não está carregado. Verifique a conexão ou o script no topo do arquivo.");
      return;
    }

    infoPDF.textContent = "Processando PDFs...";

    let totalPaginas = 0;
    let totalEtiquetasOk = 0;

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        const numPages = pdf.numPages;
        totalPaginas += numPages;

        for (let pageNum = 1; pageNum <= numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const textContent = await page.getTextContent();
          const texto = textContent.items.map(it => it.str).join('\n');

          const resultado = processarTextoEtiqueta(texto);
          if (resultado && resultado.length > 0) {
            totalEtiquetasOk += resultado.length;
          }
        }
      } catch (e) {
        console.error(e);
        adicionarLogEntrada('erro', `Erro ao processar PDF "${file.name}": ${e}`);
      }
    }

    renderTabela();
    infoPDF.textContent =
      `Processamento concluído. PDFs: ${files.length}, páginas: ${totalPaginas}, etiquetas reconhecidas: ${totalEtiquetasOk}.`;
  });

  // Função que lê o texto completo de uma página de etiqueta
  // e tenta achar:
  //  - código de rastreio na linha com "#UP2F..."
  //  - linha "1. ALGUM SKU AQUI *QTD"
  function processarTextoEtiqueta(textoPagina) {
    // 1) Código de rastreio
    // exemplo: "SKU: 1; Total Items: 1; #UP2F42333526; Deadline:04/11/2025"
    let codigoRastreio = null;
    const regexRastreio = /#([A-Z0-9]+)/;
    const matchRast = textoPagina.match(regexRastreio);
    if (matchRast) {
      codigoRastreio = matchRast[1];
    }

    // 2) Linhas de SKU: procuramos padrões "1. ALGUM TEXTO *NUM"
    const linhas = textoPagina.split(/\r?\n/);
    const resultados = [];

    const regexSkuLinha = /^\s*\d+\.\s*([^\*]+?)\s*\*(\d+)\s*$/;

    for (const linha of linhas) {
      const m = linha.match(regexSkuLinha);
      if (m) {
        const skuEtiquetaLido = m[1].trim();   // exemplo: "CS-30" ou "D-Y03LARANJA (LARANJA)"
        const qtd = parseInt(m[2], 10) || 0;

        const status = registrarSaidaPorEtiqueta(skuEtiquetaLido, qtd, codigoRastreio);
        resultados.push({ skuEtiqueta: skuEtiquetaLido, qtd, codigoRastreio, status });
      }
    }

    return resultados;
  }

  // =========================
  // 9) Registrar saída de estoque a partir da etiqueta
  // =========================
  function registrarSaidaPorEtiqueta(skuEtiquetaLido, qtd, codigoRastreio) {
    const skuLabelNorm = normalizarTexto(skuEtiquetaLido);

    // Checar duplicidade de código de rastreio (se existir)
    let duplicado = false;
    if (codigoRastreio) {
      if (codigosRastreioLidos.has(codigoRastreio)) {
        duplicado = true;
      } else {
        codigosRastreioLidos.add(codigoRastreio);
      }
    }

    // Tenta encontrar o item pelo SKU de etiqueta
    let item = itens.find(it => normalizarTexto(it.skuEtiqueta) === skuLabelNorm);

    if (!item) {
      // SKU não encontrado
      const msg = `SKU etiqueta NÃO encontrado: "${skuEtiquetaLido}" (qtd=${qtd})` +
        (codigoRastreio ? ` | rastreio: ${codigoRastreio}` : "");
      adicionarLogEntrada('erro', msg);
      tocarBeepErro();
      return 'nao_encontrado';
    }

    if (duplicado) {
      const msg = `DUPLICADO: rastreio ${codigoRastreio} | SKU etiqueta: "${skuEtiquetaLido}" | qtd=${qtd}`;
      adicionarLogEntrada('dup', msg);
      tocarBeepErro();
      return 'duplicado';
    }

    // Se não for duplicado, soma ao bipado
    item.bipado = (item.bipado || 0) + qtd;

    const esperado = Number(item.qty) || 0;
    const bip = item.bipado;

    let msgStatus = "";
    if (bip > esperado && esperado > 0) {
      msgStatus = `ALERTA EXCESSO: "${item.skuEtiqueta}" bipado ${bip}/${esperado}` +
        (codigoRastreio ? ` | rastreio: ${codigoRastreio}` : "");
    } else if (bip === esperado && esperado > 0) {
      msgStatus = `OK COMPLETO: "${item.skuEtiqueta}" atingiu ${bip}/${esperado}` +
        (codigoRastreio ? ` | rastreio: ${codigoRastreio}` : "");
    } else {
      msgStatus = `PENDENTE: "${item.skuEtiqueta}" bipado ${bip}/${esperado}` +
        (codigoRastreio ? ` | rastreio: ${codigoRastreio}` : "");
    }

    adicionarLogEntrada('ok', msgStatus);
    tocarBeepSucesso();
    return 'ok';
  }

  // =========================
  // 10) Inicialização geral
  // =========================
  inicializarItens();
</script>
</body>
</html>
