<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Estoque por PDF - SKU + Rastreamento</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      background: #f4f4f4;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    h1, h2 {
      margin: 6px 0;
      font-size: 20px;
    }
    p {
      margin: 4px 0;
      font-size: 13px;
    }
    .small { font-size: 12px; color: #555; }
    input, button {
      font-size: 13px;
      padding: 6px 8px;
      margin: 3px 0;
    }
    input[type="text"], input[type="number"], input[type="file"] {
      width: 100%;
      box-sizing: border-box;
    }
    button { cursor: pointer; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: left;
    }
    th {
      background: #eee;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .row-actions button {
      font-size: 11px;
      padding: 2px 5px;
    }
    .ok { background: #e0ffe0; }
    .pendente { background: #fffbe0; }
    .alerta { background: #ffe0e0; }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
    }
    .badge-ok { background: #c6f6c6; }
    .badge-pendente { background: #fff4b3; }
    .badge-alerta { background: #ffc4c4; }
    .log-area {
      max-height: 200px;
      overflow: auto;
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 5px;
      font-size: 12px;
      white-space: pre-wrap;
    }
    @media (min-width: 700px) {
      .form-grid {
        display: grid;
        grid-template-columns: 2fr 2fr 1fr auto;
        gap: 6px;
        align-items: center;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Controle de Estoque com PDFs de Etiquetas</h1>

  <p class="small">
    • Estoque inicial: 300 peças para cada variação da <b>Planilha SKU</b> embutida no código.<br>
    • Para cada página do PDF, o sistema procura a linha <code>SKU: 1; ...</code> e a linha seguinte
      <code>1. &lt;SKU COMPLETO&gt; *QTD</code> e usa isso para abater do estoque.<br>
    • Também captura o código de rastreio (ex.: <code>BR257793035262E</code>) para marcar etiquetas duplicadas.
  </p>

  <!-- 1) Upload de PDFs -->
  <h2>1) Ler etiquetas a partir de PDF</h2>
  <p class="small">
    Selecione um ou mais arquivos PDF de etiquetas (MEGA EXPLOSAO).<br>
    O sistema irá extrair SKU, quantidade e código de rastreio de cada página.
  </p>
  <input type="file" id="inputPdf" accept="application/pdf" multiple />
  <button id="btnProcessarPdf">Ler etiquetas do(s) PDF(s)</button>
  <div id="statusPdf" class="small"></div>
  <h3>Log de leitura</h3>
  <div id="logLeitura" class="log-area"></div>

  <!-- 2) Adicionar / atualizar itens -->
  <h2>2) Adicionar / atualizar itens manualmente</h2>
  <p class="small">
    Se precisar incluir ou ajustar algum SKU da planilha manualmente:
  </p>
  <div class="form-grid">
    <div>
      <label>SKU (planilha)</label><br>
      <input type="text" id="novoSku" placeholder="Ex: D-3204, KP-7023, ON-FN632...">
    </div>
    <div>
      <label>Cor (planilha)</label><br>
      <input type="text" id="novaCor" placeholder="Ex: PRETO, AZUL, ROSA...">
    </div>
    <div>
      <label>Quantidade esperada</label><br>
      <input type="number" id="novaQtd" value="300" min="0">
    </div>
    <div>
      <button id="btnAdicionar">Adicionar / Atualizar</button>
    </div>
  </div>
  <div id="resumo" class="small"></div>

  <!-- 3) Tabela de itens -->
  <h2>3) Itens em estoque (Planilha + ajustes)</h2>
  <div style="max-height: 360px; overflow:auto;">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>SKU (planilha)</th>
          <th>Cor (planilha)</th>
          <th>SKU padrão etiqueta</th>
          <th>Qtd esperada</th>
          <th>Bipado (PDF)</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyItens"></tbody>
    </table>
  </div>
</div>

<!-- pdf.js via CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
<script>
  // ============================================================
  // 1) Dados base da Planilha (mesmos do HTML anterior)
  // ============================================================
  const itensBasePlanilha = [
    {"sku": "KP-RO826", "cor": "", "qty": 300},
    {"sku": "KP-RO852", "cor": "", "qty": 300},
    {"sku": "KP-RO832", "cor": "", "qty": 300},
    {"sku": "KP-548B", "cor": "", "qty": 300},
    {"sku": "KP-TC07", "cor": "", "qty": 300},
    {"sku": "KP-LB521", "cor": "", "qty": 300},
    {"sku": "KP-TE119", "cor": "", "qty": 300},
    {"sku": "KP-517", "cor": "", "qty": 300},
    {"sku": "KP-7023", "cor": "PRETO", "qty": 300},
    {"sku": "KP-7023", "cor": "BCO", "qty": 300},
    {"sku": "KP-7023", "cor": "AZUL", "qty": 300},
    {"sku": "KP-MU003", "cor": "", "qty": 300},
    {"sku": "KP-RO833", "cor": "", "qty": 300},
    {"sku": "KP-MU014", "cor": "", "qty": 300},
    {"sku": "KP-TE112", "cor": "PRETO", "qty": 300},
    {"sku": "KP-TE112", "cor": "VERDE", "qty": 300},
    {"sku": "KP-TE112", "cor": "ROSA", "qty": 300},
    {"sku": "KP-5816", "cor": "", "qty": 300},
    {"sku": "KP-CA127", "cor": "", "qty": 300},
    {"sku": "KP-ONFN639", "cor": "", "qty": 300},
    {"sku": "KP-ONF90", "cor": "", "qty": 300},
    {"sku": "KP-2064", "cor": "", "qty": 300},
    {"sku": "KP-TC19", "cor": "", "qty": 300},
    {"sku": "KP-TE115", "cor": "", "qty": 300},
    {"sku": "KP-TE124", "cor": "", "qty": 300},
    {"sku": "KP-6040", "cor": "", "qty": 300},
    {"sku": "KP-IM600", "cor": "", "qty": 300},
    {"sku": "KP-LBFN606", "cor": "", "qty": 300},
    {"sku": "KP-RO802", "cor": "", "qty": 300},
    {"sku": "KP-PN899", "cor": "PRETO", "qty": 300},
    {"sku": "KP-PN899", "cor": "BRANCO", "qty": 300},
    {"sku": "D-3204", "cor": "", "qty": 300},
    {"sku": "D-Y03", "cor": "AZUL", "qty": 300},
    {"sku": "D-Y03", "cor": "VERM", "qty": 300},
    {"sku": "D-Y03", "cor": "LARANJA", "qty": 300},
    {"sku": "D-Y03", "cor": "PRATA", "qty": 300},
    {"sku": "D-Y03", "cor": "PRETA", "qty": 300},
    {"sku": "D-3210", "cor": "", "qty": 300},
    {"sku": "D-F12", "cor": "", "qty": 300},
    {"sku": "D-6201", "cor": "", "qty": 300},
    {"sku": "D-P13", "cor": "", "qty": 300},
    {"sku": "D-G105", "cor": "", "qty": 300},
    {"sku": "D-3142", "cor": "", "qty": 300},
    {"sku": "D-F8", "cor": "", "qty": 300},
    {"sku": "D-F13", "cor": "", "qty": 300},
    {"sku": "D-F11", "cor": "", "qty": 300},
    {"sku": "D-F14", "cor": "", "qty": 300},
    {"sku": "D-S14", "cor": "", "qty": 300},
    {"sku": "D-S4145", "cor": "", "qty": 300},
    {"sku": "D-EM07", "cor": "", "qty": 300},
    {"sku": "D-3205", "cor": "", "qty": 300},
    {"sku": "D-4235", "cor": "", "qty": 300},
    {"sku": "D-S30", "cor": "", "qty": 300},
    {"sku": "D-BH2807", "cor": "", "qty": 300},
    {"sku": "D-4232", "cor": "", "qty": 300},
    {"sku": "D-3158", "cor": "PRETO", "qty": 300},
    {"sku": "D-3158", "cor": "AZUL", "qty": 300},
    {"sku": "D-3158", "cor": "AMARELO", "qty": 300},
    {"sku": "D-3158", "cor": "VERM", "qty": 300},
    {"sku": "D-3158", "cor": "VERDE", "qty": 300},
    {"sku": "D-BH1065", "cor": "", "qty": 300},
    {"sku": "D-BH1064", "cor": "", "qty": 300},
    {"sku": "D-BH1051", "cor": "", "qty": 300},
    {"sku": "D-BH1050", "cor": "", "qty": 300},
    {"sku": "D-BH1019", "cor": "", "qty": 300},
    {"sku": "D-1601", "cor": "", "qty": 300},
    {"sku": "D-3151", "cor": "", "qty": 300},
    {"sku": "D-Y04/05", "cor": "", "qty": 300},
    {"sku": "D-NK1201", "cor": "", "qty": 300},
    {"sku": "D-MN001", "cor": "", "qty": 300},
    {"sku": "D-TELA04", "cor": "", "qty": 300},
    {"sku": "D-TELA02", "cor": "", "qty": 300},
    {"sku": "D-AI05", "cor": "", "qty": 300},
    {"sku": "D-A24E9903", "cor": "", "qty": 300},
    {"sku": "D-AI06", "cor": "", "qty": 300},
    {"sku": "D-X338", "cor": "", "qty": 300},
    {"sku": "D-XK300", "cor": "", "qty": 300},
    {"sku": "D-S8122", "cor": "", "qty": 300},
    {"sku": "D-Y07", "cor": "", "qty": 300},
    {"sku": "D-XK101", "cor": "", "qty": 300},
    {"sku": "D-X612", "cor": "", "qty": 300},
    {"sku": "PROT. AURICULAR", "cor": "", "qty": 300},
    {"sku": "PAPABOLINHAS", "cor": "", "qty": 300},
    {"sku": "M-303", "cor": "", "qty": 300},
    {"sku": "CS-30", "cor": "", "qty": 300},
    {"sku": "RO-832", "cor": "", "qty": 300},
    {"sku": "LB-521", "cor": "", "qty": 300},
    {"sku": "FONE", "cor": "", "qty": 300},
    {"sku": "PG-9023S", "cor": "", "qty": 300},
    {"sku": "XKO01PRETO", "cor": "", "qty": 300},
    {"sku": "ON-FN632", "cor": "BRANCO", "qty": 300},
    {"sku": "ON-FN632", "cor": "ROSA", "qty": 300},
    {"sku": "ON-FN632", "cor": "VERDE", "qty": 300},
    {"sku": "ON-FN632", "cor": "ROXO", "qty": 300},
    {"sku": "ON-FN632", "cor": "AZUL", "qty": 300},
    {"sku": "TE-115", "cor": "", "qty": 300},
    {"sku": "TE-119", "cor": "", "qty": 300},
    {"sku": "TE-121", "cor": "", "qty": 300},
    {"sku": "TE-124", "cor": "", "qty": 300},
    {"sku": "PN-899", "cor": "", "qty": 300},
    {"sku": "CANETA TERMICA", "cor": "", "qty": 300},
    {"sku": "TABLET INFANTIL", "cor": "AZUL", "qty": 300},
    {"sku": "TABLET INFANTIL", "cor": "ROSA", "qty": 300},
    {"sku": "KP-TE129", "cor": "", "qty": 300},
    {"sku": "KP-TE146", "cor": "", "qty": 300},
    {"sku": "D-TELA03", "cor": "", "qty": 300},
    {"sku": "D-TELA05", "cor": "", "qty": 300},
    {"sku": "D-TELA06", "cor": "", "qty": 300},
    {"sku": "D-TELA07", "cor": "", "qty": 300},
    {"sku": "D-BH1064", "cor": "VERMELHO", "qty": 300},
    {"sku": "D-BH1064", "cor": "PRETO", "qty": 300},
    {"sku": "D-BH1064", "cor": "ROSA", "qty": 300},
    {"sku": "D-BH1064", "cor": "PRATA", "qty": 300},
    {"sku": "D-BH1064", "cor": "ROSÉ", "qty": 300},
    {"sku": "D-BH1051", "cor": "AZUL", "qty": 300},
    {"sku": "D-BH1051", "cor": "PRETO", "qty": 300},
    {"sku": "D-BH1051", "cor": "ROSÉ", "qty": 300},
    {"sku": "D-BH1051", "cor": "ROSA", "qty": 300},
    {"sku": "D-BH1051", "cor": "VERMELHO", "qty": 300},
    {"sku": "D-BH1051", "cor": "PRATA", "qty": 300},
    {"sku": "D-BH1050", "cor": "AZUL", "qty": 300},
    {"sku": "D-BH1050", "cor": "PRETO", "qty": 300},
    {"sku": "D-BH1050", "cor": "ROSÉ", "qty": 300},
    {"sku": "D-BH1050", "cor": "PRATA", "qty": 300},
    {"sku": "AI07", "cor": "", "qty": 300},
    {"sku": "AI03", "cor": "", "qty": 300},
    {"sku": "D-BH8115", "cor": "", "qty": 300},
    {"sku": "D-238G 180H", "cor": "", "qty": 300},
    {"sku": "DS-14", "cor": "PRETO", "qty": 300},
    {"sku": "KP-397", "cor": "VERMELHO", "qty": 300},
    {"sku": "KP-FN632", "cor": "ROSA", "qty": 300},
    {"sku": "KP-FN632", "cor": "VERDE", "qty": 300},
    {"sku": "D-FT101", "cor": "", "qty": 300},
    {"sku": "DRONE", "cor": "", "qty": 300},
    {"sku": "RO802", "cor": "", "qty": 300}
  ];

  let itens = [];
  let proximoId = 1;
  const tbodyItens = document.getElementById("tbodyItens");
  const resumoDiv = document.getElementById("resumo");
  const logLeitura = document.getElementById("logLeitura");
  const statusPdf = document.getElementById("statusPdf");

  // controle de rastreios já lidos (duplicidade)
  const rastreiosLidos = new Set();

  // ============================================================
  // 2) Utilitários de texto / SKU / cor
  // ============================================================
  function normalizarCorCanon(cor) {
    if (!cor) return "";
    let c = cor.toString().trim().toUpperCase();

    c = c
      .replace(/[ÁÀÂÃ]/g, "A")
      .replace(/[ÉÈÊ]/g, "E")
      .replace(/[ÍÌÎ]/g, "I")
      .replace(/[ÓÒÔÕ]/g, "O")
      .replace(/[ÚÙÛ]/g, "U")
      .replace(/Ç/g, "C");

    c = c.replace(/\s+/g, " ");

    const mapa = {
      "BCO": "BRANCO",
      "BRAN": "BRANCO",
      "BRANCO": "BRANCO",
      "PRETA": "PRETO",
      "PRETO": "PRETO",
      "PT": "PRETO",
      "PTO": "PRETO",
      "AZUL": "AZUL",
      "VERDE": "VERDE",
      "VD": "VERDE",
      "ROSA": "ROSA",
      "VERM": "VERMELHO",
      "VERMELHO": "VERMELHO",
      "LARANJA": "LARANJA",
      "CINZA": "CINZA",
      "MARROM": "MARROM",
      "LILAS": "LILAS",
      "ROXO": "ROXO",
      "ROSE": "ROSE",
      "ROSEGOLD": "ROSE"
    };

    const semEspaco = c.replace(/\s+/g, "");
    if (mapa[semEspaco]) return mapa[semEspaco];
    if (mapa[c]) return mapa[c];
    return c;
  }

  function prettyCor(c) {
    return c ? c.toUpperCase() : "";
  }

  // gera o "SKU p/ etiqueta" (como era usado na câmera)
  function adaptarSkuParaPdf(skuOriginal, corOriginal) {
    if (!skuOriginal) return "";
    const skuUp = skuOriginal.toString().trim().toUpperCase();
    const corCanon = normalizarCorCanon(corOriginal || "");
    const corPretty = prettyCor(corCanon);

    if (skuUp === "D-3204") return "D-3204+MIC";
    if (skuUp === "D-3210") return "D-3210 (SEM MICROFONE)";

    if (skuUp === "D-3158" || skuUp === "D-S3158") {
      const base = "D-S3158";
      return corPretty ? `${base} (${corPretty})` : base;
    }

    if (skuUp === "D-Y03") {
      if (corCanon) return "D-Y03" + corCanon + " (" + corPretty + ")";
      return "D-Y03";
    }

    if (skuUp === "D-Y04" || skuUp === "D-Y05" || skuUp === "D-Y04/05") {
      return corPretty ? `${skuUp} (${corPretty})` : skuUp;
    }

    if (skuUp === "KP-7023") {
      return corCanon ? `KP-7023${corCanon} (${corPretty})` : "KP-7023";
    }

    if (skuUp === "ON-FN632" || skuUp === "KP-FN632") {
      return corCanon ? `ON-FN632${corCanon} (${corPretty})` : "ON-FN632";
    }

    if (skuUp === "KP-TE115" || skuUp === "TE-115") {
      return "TE-115 (Tecnologia Anti-Ghost)";
    }

    if (skuUp === "KP-TE124" || skuUp === "TE-124") {
      return "TE-124 (Iluminação RGB Gamer)";
    }

    if (skuUp === "KP-TE112") {
      return corCanon ? `KP-TE112${corCanon} (${corPretty})` : "KP-TE112";
    }

    if (skuUp === "KP-LB521" || skuUp === "LB-521") return "LB-521";
    if (skuUp === "KP-PN899" || skuUp === "PN-899") return "PN-899PD";
    if (skuUp === "PROT. AURICULAR" || skuUp === "PROT AURICULAR") return "PROTETOR AURICULAR";
    if (skuUp === "D-MN001" || skuUp === "MONITOR D-MN001") return "MONITOR D-MN001";

    if (skuUp === "XKO01PRETO") {
      const corText = corPretty || "PRETO";
      return `XKO01PRETO (${corText})`;
    }

    if (skuUp === "CS-30") return "CS-30";
    if (skuUp === "RO-832") return "RO-832";
    if (skuUp === "PG-9023S") return "PG-9023S";
    if (skuUp === "M-303") return "M-303";
    if (skuUp === "FONE" || skuUp === "FONE LEBOSS") return "FONE LEBOSS";

    if (corPretty) return `${skuUp} (${corPretty})`;
    return skuUp;
  }

  // base genérica do SKU (para casar 3142 com D-3142, D-3204 com D-3204+MIC etc)
  function baseSku(txt) {
    if (!txt) return "";
    let t = txt.toUpperCase();
    t = t.replace(/\([^)]*\)/g, ""); // tira (COR)
    t = t.replace(/\s+/g, "");
    const m = t.match(/[0-9]/);
    if (m) t = t.slice(m.index);  // corta prefixo D-, KP-, etc.
    return t;
  }

  function extrairCorDeSkuPdf(skuPdf) {
    if (!skuPdf) return "";
    const m = skuPdf.match(/\(([^)]+)\)/);
    if (!m) return "";
    return normalizarCorCanon(m[1]);
  }

  function normalizarTexto(txt) {
    return txt ? txt.toString().trim().toUpperCase() : "";
  }

  // ============================================================
  // 3) Beeps (som de bip)
  // ============================================================
  let audioCtx = null;
  function playBeep(freq = 880, duration = 0.15) {
    try {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AC();
      }
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
      osc.start();
      osc.stop(audioCtx.currentTime + duration);
    } catch (e) {
      // se o navegador bloquear áudio, apenas ignora
    }
  }

  // ============================================================
  // 4) Inicialização e render da tabela
  // ============================================================
  function inicializarItens() {
    itens = itensBasePlanilha.map(obj => ({
      id: proximoId++,
      sku: obj.sku,
      cor: obj.cor,
      qty: obj.qty,
      bipado: 0
    }));
    renderTabela();
  }

  function renderTabela() {
    tbodyItens.innerHTML = "";
    const ordenados = [...itens].sort((a, b) => {
      const sA = a.sku.toUpperCase();
      const sB = b.sku.toUpperCase();
      if (sA < sB) return -1;
      if (sA > sB) return 1;
      const cA = (a.cor || "").toUpperCase();
      const cB = (b.cor || "").toUpperCase();
      if (cA < cB) return -1;
      if (cA > cB) return 1;
      return 0;
    });

    ordenados.forEach((item, idx) => {
      const tr = document.createElement("tr");

      const esperado = Number(item.qty) || 0;
      const bip = Number(item.bipado) || 0;

      let status = "";
      let badgeClass = "";
      let rowClass = "";
      if (esperado === 0 && bip === 0) {
        status = "Sem quantidade";
      } else if (bip === 0 && esperado > 0) {
        status = "Ainda não bipado";
        badgeClass = "badge-pendente";
        rowClass = "pendente";
      } else if (bip < esperado) {
        status = `Pendente (${bip}/${esperado})`;
        badgeClass = "badge-pendente";
        rowClass = "pendente";
      } else if (bip === esperado) {
        status = "OK (completo)";
        badgeClass = "badge-ok";
        rowClass = "ok";
      } else if (bip > esperado) {
        status = `Excesso (${bip}/${esperado})`;
        badgeClass = "badge-alerta";
        rowClass = "alerta";
      }

      tr.className = rowClass;

      const tdIdx = document.createElement("td");
      tdIdx.textContent = idx + 1;
      tr.appendChild(tdIdx);

      const tdSku = document.createElement("td");
      tdSku.textContent = item.sku;
      tr.appendChild(tdSku);

      const tdCor = document.createElement("td");
      tdCor.textContent = item.cor || "-";
      tr.appendChild(tdCor);

      const tdSkuPdf = document.createElement("td");
      tdSkuPdf.textContent = adaptarSkuParaPdf(item.sku, item.cor);
      tr.appendChild(tdSkuPdf);

      const tdQtd = document.createElement("td");
      const inputQtd = document.createElement("input");
      inputQtd.type = "number";
      inputQtd.min = "0";
      inputQtd.value = item.qty;
      inputQtd.style.width = "70px";
      inputQtd.addEventListener("change", () => {
        item.qty = Number(inputQtd.value) || 0;
        renderTabela();
      });
      tdQtd.appendChild(inputQtd);
      tr.appendChild(tdQtd);

      const tdBip = document.createElement("td");
      tdBip.textContent = bip;
      tr.appendChild(tdBip);

      const tdStatus = document.createElement("td");
      if (status) {
        const span = document.createElement("span");
        span.textContent = status;
        span.className = "badge " + badgeClass;
        tdStatus.appendChild(span);
      }
      tr.appendChild(tdStatus);

      const tdAcoes = document.createElement("td");
      tdAcoes.className = "row-actions";
      const btnRemover = document.createElement("button");
      btnRemover.textContent = "Remover";
      btnRemover.addEventListener("click", () => {
        itens = itens.filter(it => it.id !== item.id);
        renderTabela();
      });
      tdAcoes.appendChild(btnRemover);
      tr.appendChild(tdAcoes);

      tbodyItens.appendChild(tr);
    });

    atualizarResumo();
  }

  function atualizarResumo() {
    const totalItens = itens.length;
    const totalQtd = itens.reduce((s, it) => s + (Number(it.qty) || 0), 0);
    const totalBip = itens.reduce((s, it) => s + (Number(it.bipado) || 0), 0);

    resumoDiv.innerHTML =
      `<b>Total de variações:</b> ${totalItens} | ` +
      `<b>Qtd esperada total:</b> ${totalQtd} | ` +
      `<b>Qtd bipada total:</b> ${totalBip}`;
  }

  // ============================================================
  // 5) Adicionar / atualizar itens manualmente
  // ============================================================
  document.getElementById("btnAdicionar").addEventListener("click", () => {
    const sku = document.getElementById("novoSku").value.trim();
    const cor = document.getElementById("novaCor").value.trim();
    const qtd = Number(document.getElementById("novaQtd").value) || 0;

    if (!sku) {
      alert("Informe o SKU.");
      return;
    }
    adicionarOuAtualizarItem(sku, cor, qtd, true);
  });

  function adicionarOuAtualizarItem(sku, cor, qty, renderDepois) {
    const skuNorm = normalizarTexto(sku);
    const corNorm = normalizarTexto(cor);

    let itemExistente = itens.find(it =>
      normalizarTexto(it.sku) === skuNorm &&
      normalizarTexto(it.cor) === corNorm
    );

    if (itemExistente) {
      itemExistente.qty = qty;
    } else {
      itens.push({
        id: proximoId++,
        sku: sku,
        cor: cor,
        qty: qty,
        bipado: 0
      });
    }

    if (renderDepois) {
      renderTabela();
      document.getElementById("novoSku").value = "";
      document.getElementById("novaCor").value = "";
      document.getElementById("novaQtd").value = 300;
    }
  }

  // ============================================================
  // 6) Encontrar item pelo SKU lido do PDF
  // ============================================================
  function encontrarItemPorSkuPdf(skuPdf) {
    const skuPdfNorm = normalizarTexto(skuPdf);
    const basePdf = baseSku(skuPdfNorm);
    const corPdfCanon = extrairCorDeSkuPdf(skuPdfNorm);

    // 1º tentativa: bater exatamente com o SKU padrão de etiqueta
    let candidatos = itens.filter(it =>
      normalizarTexto(adaptarSkuParaPdf(it.sku, it.cor)) === skuPdfNorm
    );
    if (candidatos.length === 1) return candidatos[0];

    // 2ª tentativa: usar baseSku + cor
    candidatos = itens.filter(it => {
      const baseItem = baseSku(it.sku);
      const corItem = normalizarCorCanon(it.cor);
      if (baseItem !== basePdf) return false;
      if (!corPdfCanon) return true; // etiqueta sem cor explícita
      return corItem === corPdfCanon;
    });

    if (candidatos.length === 1) return candidatos[0];
    return null; // não encontrado ou ambíguo
  }

  // ============================================================
  // 7) Leitura de PDFs com pdf.js
  // ============================================================
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";

  document.getElementById("btnProcessarPdf").addEventListener("click", async () => {
    const input = document.getElementById("inputPdf");
    if (!input.files || input.files.length === 0) {
      alert("Selecione pelo menos um PDF.");
      return;
    }
    logLeitura.textContent = "";
    statusPdf.textContent = "Processando PDFs, aguarde...";
    let totalPaginas = 0;
    let etiquetasLidas = 0;
    let duplicadas = 0;
    let naoEncontradas = 0;

    for (const file of input.files) {
      const arrayBuf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuf }).promise;
      totalPaginas += pdf.numPages;

      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(it => it.str).join("\n");
        const resultado = processarPaginaTexto(pageText);

        if (resultado) {
          const { skuPdf, qtd, rastreio } = resultado;
          etiquetasLidas++;

          // controle de duplicidade por rastreio
          let duplicada = false;
          if (rastreio) {
            if (rastreiosLidos.has(rastreio)) {
              duplicada = true;
              duplicadas++;
              playBeep(220); // bip grave = duplicado
              log(`DUPLICADO  [${rastreio}]  SKU: ${skuPdf}  QTD: ${qtd}  (arquivo: ${file.name}, página: ${pageNum})`);
            } else {
              rastreiosLidos.add(rastreio);
            }
          }

          if (!duplicada) {
            const item = encontrarItemPorSkuPdf(skuPdf);
            if (item) {
              item.bipado = (item.bipado || 0) + qtd;
              playBeep(880); // bip agudo = ok
              log(`OK         [${rastreio || "sem rastreio"}]  SKU: ${skuPdf}  QTD: ${qtd}  -> somado em ${item.sku} (${item.cor || "-"})`);
            } else {
              naoEncontradas++;
              playBeep(660); // meio termo = SKU não achado
              log(`NAO ENCONTRADO  [${rastreio || "sem rastreio"}]  SKU etiqueta: ${skuPdf}  QTD: ${qtd}  (arquivo: ${file.name}, página: ${pageNum})`);
            }
          }
        } else {
          // página sem linha de SKU: só ignora
        }
      }
    }

    renderTabela();
    statusPdf.textContent =
      `Concluído. Páginas: ${totalPaginas}, Etiquetas lidas: ${etiquetasLidas}, ` +
      `Duplicadas: ${duplicadas}, SKU não encontrados: ${naoEncontradas}.`;
  });

  // processa texto de UMA página
  function processarPaginaTexto(pageText) {
    const linhas = pageText.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);

    let skuLinha = null;
    let qtd = 0;

    for (let i = 0; i < linhas.length; i++) {
      const line = linhas[i];

      // tenta localizar "SKU:" e pegar a linha seguinte "1. .... *Q"
      if (line.startsWith("SKU:")) {
        for (let j = i + 1; j < Math.min(i + 6, linhas.length); j++) {
          const l2 = linhas[j];
          const m = l2.match(/^1\.\s+(.+?)\s*\*([0-9]+)\s*$/);
          if (m) {
            skuLinha = m[1].trim();
            qtd = parseInt(m[2], 10);
            break;
          }
        }
      }
    }

    if (!skuLinha || !qtd) {
      return null;
    }

    // tenta achar código de rastreio na página (BR###########X, TXAS..., etc.)
    let rastreio = null;
    for (const l of linhas) {
      const m = l.match(/\bBR[0-9A-Z]{11,}\b/);
      if (m) {
        rastreio = m[0];
        break;
      }
    }
    // se não achou BR..., tenta algo tipo TXAS...
    if (!rastreio) {
      for (const l of linhas) {
        const m = l.match(/\bTX[A-Z0-9]{6,}\b/i);
        if (m) {
          rastreio = m[0];
          break;
        }
      }
    }

    return { skuPdf: skuLinha, qtd, rastreio };
  }

  function log(msg) {
    logLeitura.textContent += msg + "\n";
    logLeitura.scrollTop = logLeitura.scrollHeight;
  }

  // Inicialização
  inicializarItens();
</script>
</body>
</html>
