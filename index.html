<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Abate de Estoque por Etiquetas PDF</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f4f4f4;
    }
    h1 {
      margin-top: 0;
      font-size: 20px;
    }
    .top-bar, .actions, .search-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
      align-items: center;
    }
    label { font-size: 14px; }

    input[type="file"] {
      padding: 4px;
      font-size: 13px;
    }

    input[type="text"], input[type="number"] {
      padding: 4px 6px;
      font-size: 13px;
    }

    button {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid #ccc;
      cursor: pointer;
      background: #fff;
    }
    button:hover {
      background: #eaeaea;
    }

    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: #fff;
      border-radius: 6px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(even) {
      background: #fafafa;
    }
    tbody tr:hover {
      background: #f5f9ff;
    }

    td[contenteditable="true"] {
      background-color: #fffef4;
      outline: none;
    }

    .badge-small {
      font-size: 11px;
      padding: 2px 4px;
      border-radius: 3px;
      background: #eee;
      margin-left: 4px;
    }

    #log {
      width: 100%;
      min-height: 200px;
      resize: vertical;
      font-family: monospace;
      font-size: 11px;
      padding: 6px;
    }

    .summary {
      font-size: 12px;
      margin-bottom: 6px;
    }

    .pill {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e6f4ff;
      border: 1px solid #b3daff;
      margin-right: 4px;
      margin-bottom: 4px;
    }

    .pill strong {
      font-weight: 600;
    }

    .small-note {
      font-size: 11px;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>Abate de Estoque por Etiquetas PDF</h1>

  <div class="top-bar">
    <label for="pdfInput"><strong>PDF de etiquetas:</strong></label>
    <input type="file" id="pdfInput" accept="application/pdf" />
    <button id="processBtn">Processar PDF e abater estoque</button>
    <button id="resetStockBtn">Resetar estoque (300 para todos)</button>
  </div>

  <div class="search-bar">
    <label for="searchInput">Buscar por nome/SKU:</label>
    <input type="text" id="searchInput" placeholder="Digite parte do nome, SKU ou cor" />
    <button id="clearSearchBtn">Limpar busca</button>
    <span class="small-note">Clique nas células amarelas para editar. Botão "Excluir" remove o item.</span>
  </div>

  <div class="actions">
    <button id="addItemBtn">Adicionar item manualmente</button>
  </div>

  <div class="layout">
    <div class="panel">
      <div class="summary" id="summary"></div>
      <div style="max-height: 480px; overflow: auto; border: 1px solid #ddd;">
        <table id="stockTable">
          <thead>
            <tr>
              <th>#</th>
              <th>SKU (planilha)</th>
              <th>Cor</th>
              <th>SKU p/ bipagem (padrão PDF)</th>
              <th>Descrição</th>
              <th>Estoque atual</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="panel">
      <div class="summary">
        <div class="pill"><strong>Leitura SKU:</strong> procura trecho entre <code>1.</code> e <code>*qtd</code></div>
        <div class="pill"><strong>Variações:</strong> texto completo, sem cor <code>(...)</code>, primeira palavra, primeiro código tipo <code>D-3204+MIC</code></div>
        <div class="pill"><strong>Casamento:</strong> normaliza removendo espaços e símbolos, compara com planilha</div>
      </div>

      <textarea id="log" readonly placeholder="Log de processamento do PDF aparecerá aqui..."></textarea>
      <div style="margin-top: 6px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="clearLogBtn">Limpar log</button>
      </div>

      <p class="small-note" style="margin-top:8px;">
        Observação: este arquivo usa <strong>pdf.js</strong>. Para funcionar offline, deixe
        <code>pdf.js</code> e <code>pdf.worker.js</code> na mesma pasta deste HTML e mantenha os nomes
        dos arquivos como estão nas linhas de script.
      </p>
    </div>
  </div>

  <!-- pdf.js local -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
</script>

  <script>
    // Configuração do pdf.js (ajuste o caminho se necessário)
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.js';
    }

    // ====================== PLANILHA FIXA (CSV EMBUTIDO) ======================
    // Todos os itens começam com 300 de estoque (Qtd esperada ignorada e forçada para 300)
    const csvData = `SKU (planilha);Cor (planilha);SKU p/ bipagem (padrÆo PDF);Qtd esperada
KP-RO826;;KP-RO826;300
KP-RO852;;KP-RO852;300
KP-RO832;;KP-RO832;300
KP-548B;;KP-548B;300
KP-TC07;;KP-TC07;300
KP-LB521;;LB-521;300
KP-TE119;;KP-TE119;300
KP-517;;KP-517;300
KP-7023;PRETO;KP-7023PRETO (PRETO);300
KP-7023;BCO;KP-7023BRANCO (BRANCO);300
KP-7023;AZUL;KP-7023AZUL (AZUL);300
KP-MU003;;KP-MU003;300
KP-RO833;;KP-RO833;300
KP-MU014;;KP-MU014;300
KP-TE112;PRETO;KP-TE112PRETO (PRETO);300
KP-TE112;VERDE;KP-TE112VERDE (VERDE);300
KP-TE112;ROSA;KP-TE112ROSA (ROSA);300
KP-5816;;KP-5816;300
KP-CA127;;KP-CA127;300
KP-ONFN639;;KP-ONFN639;300
KP-ONF90;;KP-ONF90;300
KP-2064;;KP-2064;300
KP-TC19;;KP-TC19;300
KP-TE115;;TE-115 (Tecnologia Anti-Ghost);300
KP-TE124;;TE-124 (IluminaÆo RGB Gamer);300
KP-6040;;KP-6040;300
KP-IM600;;KP-IM600;300
KP-LBFN606;;KP-LBFN606;300
KP-RO802;;KP-RO802;300
KP-PN899;PRETO;PN-899PD;300
KP-PN899;BRANCO;PN-899PD;300
D-3204;;D-3204+MIC;300
D-Y03;AZUL;D-Y03AZUL (AZUL);300
D-Y03;VERM;D-Y03VERMELHO (VERMELHO);300
D-Y03;LARANJA;D-Y03LARANJA (LARANJA);300
D-Y03;PRATA;D-Y03PRATA (PRATA);300
D-Y03;PRETA;D-Y03PRETO (PRETO);300
D-3210;;D-3210 (SEM MICROFONE);300
D-F12;;D-F12;300
D-6201;;D-6201;300
D-P13;;D-P13;300
D-G105;;D-G105;300
D-3142;;D-3142;300
D-F8;;D-F8;300
D-F13;;D-F13;300
D-F11;;D-F11;300
D-F14;;D-F14;300
D-S14;;D-S14;300
D-S4145;;D-S4145;300
D-EM07;;D-EM07;300
D-3205;;D-3205;300
D-4235;;D-4235;300
D-S30;;D-S30;300
D-BH2807;;D-BH2807;300
D-4232;;D-4232;300
D-3158;PRETO;D-S3158 (PRETO);300
D-3158;AZUL;D-S3158 (AZUL);300
D-3158;AMARELO;D-S3158 (AMARELO);300
D-3158;VERM;D-S3158 (VERMELHO);300
D-3158;VERDE;D-S3158 (VERDE);300
D-BH1065;;D-BH1065;300
D-BH1064;;D-BH1064;300
D-BH1051;;D-BH1051;300
D-BH1050;;D-BH1050;300
D-BH1019;;D-BH1019;300
D-1601;;D-1601;300
D-3151;;D-3151;300
D-Y04/05;;D-Y04/05;300
D-NK1201;;D-NK1201;300
D-MN001;;MONITOR D-MN001;300
D-TELA04;;D-TELA04;300
D-TELA02;;D-TELA02;300
D-AI05;;D-AI05;300
D-A24E9903;;D-A24E9903;300
D-AI06;;D-AI06;300
D-X338;;D-X338;300
D-XK300;;D-XK300;300
D-S8122;;D-S8122;300
D-Y07;;D-Y07;300
D-XK101;;D-XK101;300
D-X612;;D-X612;300
PROT. AURICULAR;;PROTETOR AURICULAR;300
PAPABOLINHAS;;PAPABOLINHAS;300
M-303;;M-303;300
CS-30;;CS-30;300
RO-832;;RO-832;300
LB-521;;LB-521;300
FONE;;FONE LEBOSS;300
PG-9023S;;PG-9023S;300
XKO01PRETO;;XKO01PRETO (PRETO);300
ON-FN632;BRANCO;ON-FN632BRANCO (BRANCO);300
ON-FN632;ROSA;ON-FN632ROSA (ROSA);300
ON-FN632;VERDE;ON-FN632VERDE (VERDE);300
ON-FN632;ROXO;ON-FN632ROXO (ROXO);300
ON-FN632;AZUL;ON-FN632AZUL (AZUL);300
TE-115;;TE-115 (Tecnologia Anti-Ghost);300
TE-119;;TE-119;300
TE-121;;TE-121;300
TE-124;;TE-124 (IluminaÆo RGB Gamer);300
PN-899;;PN-899PD;300
CANETA TERMICA;;CANETA TERMICA;300
TABLET INFANTIL;azul;TABLET INFANTIL (AZUL);300
TABLET INFANTIL;rosa;TABLET INFANTIL (ROSA);300
KP-TE129;;KP-TE129;300
KP-TE146;;KP-TE146;300
D-TELA03;;D-TELA03;300
D-TELA05;;D-TELA05;300
D-TELA06;;D-TELA06;300
D-TELA07;;D-TELA07;300
D-BH1064;VERMELHO;D-BH1064 (VERMELHO);300
D-BH1064;PRETO;D-BH1064 (PRETO);300
D-BH1064;ROSA;D-BH1064 (ROSA);300
D-BH1064;PRATA;D-BH1064 (PRATA);300
D-BH1064;ROS;D-BH1064 (ROSE);300
D-BH1051;AZUL;D-BH1051 (AZUL);300
D-BH1051;PRETO;D-BH1051 (PRETO);300
D-BH1051;ROS;D-BH1051 (ROSE);300
D-BH1051;ROSA;D-BH1051 (ROSA);300
D-BH1051;VERMELHO;D-BH1051 (VERMELHO);300
D-BH1051;PRATA;D-BH1051 (PRATA);300
D-BH1050;AZUL;D-BH1050 (AZUL);300
D-BH1050;PRETO;D-BH1050 (PRETO);300
D-BH1050;ROS;D-BH1050 (ROSE);300
D-BH1050;PRATA;D-BH1050 (PRATA);300
AI07;;AI07;300
AI03;;AI03;300
D-BH8115;;D-BH8115;300
D-238G 180H;;D-238G 180H;300
DS-14;PRETO;DS-14 (PRETO);300
KP-397;VERMELHO;KP-397 (VERMELHO);300
KP-FN632;ROSA;ON-FN632ROSA (ROSA);300
KP-FN632;VERDE;ON-FN632VERDE (VERDE);300
D-FT101;;D-FT101;300
DRONE;;DRONE;300
RO802;;RO802;300
`;

    // ====================== ESTADO E UTILITÁRIOS ======================

    function parseCsvToItems(csvText) {
      const lines = csvText.trim().split(/\r?\n/);
      const header = lines.shift().split(';');
      const idxSkuPlan = header.indexOf('SKU (planilha)');
      const idxCor = header.indexOf('Cor (planilha)');
      const idxSkuBip = header.indexOf('SKU p/ bipagem (padrÆo PDF)');
      const items = [];
      lines.forEach((line, i) => {
        const cols = line.split(';');
        items.push({
          id: i + 1,
          skuPlanilha: (cols[idxSkuPlan] || '').trim(),
          corPlanilha: (cols[idxCor] || '').trim(),
          skuBipagem: (cols[idxSkuBip] || '').trim(),
          descricao: '',
          estoqueInicial: 300,
          estoqueAtual: 300,
          normSkuPlanilha: '',
          normSkuBipagem: ''
        });
      });
      return items;
    }

    function normalizeSku(str) {
  // Normaliza para comparação: tudo maiúsculo, sem espaços, sem símbolos
  return (str || '')
    .toString()
    .toUpperCase()
    .replace(/[^A-Z0-9]/g, ''); // remove tudo que não é letra ou número
}

// Extrai o "código base" do SKU (primeiro código tipo D-Y05, KP-TE115, TE-115 etc.)
function extractCoreCode(str) {
  if (!str) return '';
  const upper = str.toString().toUpperCase();

  // Remove qualquer coisa em parênteses (cores, descrições etc.)
  const noParens = upper.replace(/\([^)]*\)/g, ' ');

  // Acha o primeiro trecho que pareça um código (letras/números com - / + opcional)
  const match = noParens.match(/[A-Z0-9][A-Z0-9\-\/\+]*/);
  if (!match) return '';

  // Normaliza esse trecho (remove - + /, espaços etc.)
  return normalizeSku(match[0]);
}


    function escapeHtml(str) {
      return (str ?? '').toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    let items = parseCsvToItems(csvData);
    const originalItems = JSON.parse(JSON.stringify(items)); // backup se quiser reset geral
    let skuIndex = new Map();
    let currentFilter = '';

    function rebuildSkuIndex() {
  skuIndex = new Map();
  items.forEach((item, idx) => {
    // Normalizações completas
    item.normSkuPlanilha = normalizeSku(item.skuPlanilha);
    item.normSkuBipagem = normalizeSku(item.skuBipagem);

    // Códigos base (tipo DY05, D3204, KPTE115 etc.)
    const corePlanilha = extractCoreCode(item.skuPlanilha);
    const coreBipagem = extractCoreCode(item.skuBipagem);

    // Vamos indexar por vários "jeitos" possíveis de encontrar o item
    const keys = new Set([
      item.normSkuPlanilha,
      item.normSkuBipagem,
      corePlanilha,
      coreBipagem
    ]);

    keys.forEach(k => {
      if (k && !skuIndex.has(k)) {
        skuIndex.set(k, idx);
      }
    });
  });
}


    function updateSummary() {
      const totalItens = items.length;
      const totalEstoque = items.reduce((acc, it) => acc + (Number(it.estoqueAtual) || 0), 0);
      const summaryEl = document.getElementById('summary');
      summaryEl.textContent = `Itens na planilha: ${totalItens} | Soma de estoque atual: ${totalEstoque}`;
    }

    function renderTable() {
      const tbody = document.querySelector('#stockTable tbody');
      tbody.innerHTML = '';
      const filter = (currentFilter || '').toLowerCase();

      items.forEach(item => {
        const rowText = [
          item.skuPlanilha,
          item.corPlanilha,
          item.skuBipagem,
          item.descricao
        ].join(' ').toLowerCase();

        if (filter && !rowText.includes(filter)) return;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.id}</td>
          <td contenteditable="true" data-field="skuPlanilha" data-id="${item.id}">${escapeHtml(item.skuPlanilha)}</td>
          <td contenteditable="true" data-field="corPlanilha" data-id="${item.id}">${escapeHtml(item.corPlanilha)}</td>
          <td contenteditable="true" data-field="skuBipagem" data-id="${item.id}">${escapeHtml(item.skuBipagem)}</td>
          <td contenteditable="true" data-field="descricao" data-id="${item.id}">${escapeHtml(item.descricao)}</td>
          <td contenteditable="true" data-field="estoqueAtual" data-id="${item.id}">${escapeHtml(item.estoqueAtual)}</td>
          <td><button data-action="delete" data-id="${item.id}">Excluir</button></td>
        `;
        tbody.appendChild(tr);
      });

      updateSummary();
      rebuildSkuIndex();
    }

    function addLog(message) {
      const logEl = document.getElementById('log');
      logEl.value += message + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').value = '';
    }

    function resetStockTo300() {
      items.forEach(it => {
        it.estoqueAtual = 300;
      });
      renderTable();
      addLog('Estoque de todos os itens resetado para 300.\n');
    }

    function addNewItem() {
      const maxId = items.reduce((max, it) => Math.max(max, it.id), 0);
      const newItem = {
        id: maxId + 1,
        skuPlanilha: '',
        corPlanilha: '',
        skuBipagem: '',
        descricao: '',
        estoqueInicial: 300,
        estoqueAtual: 300,
        normSkuPlanilha: '',
        normSkuBipagem: ''
      };
      items.push(newItem);
      renderTable();
      addLog(`Novo item adicionado com id ${newItem.id}.`);
    }

    function buildSkuCandidates(rawPart) {
  const candidates = [];
  const base = rawPart.replace(/\s+/g, ' ').trim();
  if (base) candidates.push(base);

  // Sem qualquer coisa em parênteses (cores, descrições)
  const withoutColor = base.replace(/\([^)]*\)/g, ' ').trim();
  if (withoutColor && !candidates.includes(withoutColor)) {
    candidates.push(withoutColor);
  }

  // Só a primeira palavra
  const firstWord = base.split(/\s+/)[0];
  if (firstWord && !candidates.includes(firstWord)) {
    candidates.push(firstWord);
  }

  // Primeiro bloco que parece código (letras/números com - / + /)
  const codeMatch = base.match(/[A-Z0-9][A-Z0-9\-\/\+]*/i);
  if (codeMatch && !candidates.includes(codeMatch[0])) {
    candidates.push(codeMatch[0]);
  }

  // Código base usando a mesma lógica da planilha
  const core = extractCoreCode(base);
  if (core && !candidates.includes(core)) {
    candidates.push(core);
  }

  return candidates;
}


    function findItemBySkuCandidates(candidates) {
  for (const cand of candidates) {
    if (!cand) continue;

    // Normalização direta
    const norm = normalizeSku(cand);
    if (norm) {
      const idx = skuIndex.get(norm);
      if (idx !== undefined) return items[idx];
    }

    // Tenta também com o código base
    const core = extractCoreCode(cand);
    if (core) {
      const idx2 = skuIndex.get(core);
      if (idx2 !== undefined) return items[idx2];
    }
  }
  return null;
}


    async function processPdfFile(file) {
      if (!window['pdfjsLib']) {
        alert('pdf.js não foi carregado. Confira se pdf.js e pdf.worker.js estão na mesma pasta.');
        return;
      }

      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      let movimentosAplicados = 0;
      let movimentosNaoEncontrados = 0;

      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();
        const text = textContent.items.map(item => item.str).join(' ');

        // Padrão principal: "1. QUALQUER_COISA *QTD"
        const regex = /1\.\s*([^*]+?)\*(\d+)/g;
        let match;

        while ((match = regex.exec(text)) !== null) {
          const rawPart = match[1].trim();
          const qty = parseInt(match[2], 10) || 0;
          if (!qty) continue;

          const candidates = buildSkuCandidates(rawPart);
          const foundItem = findItemBySkuCandidates(candidates);

          if (foundItem) {
            const antes = Number(foundItem.estoqueAtual) || 0;
            foundItem.estoqueAtual = Math.max(0, antes - qty);
            movimentosAplicados++;
            addLog(
              `Pág. ${pageNum}: SKU lido "${rawPart}" (qtd ${qty}) ` +
              `→ casou com "${foundItem.skuBipagem || foundItem.skuPlanilha}". ` +
              `Estoque: ${antes} → ${foundItem.estoqueAtual}`
            );
          } else {
            movimentosNaoEncontrados++;
            addLog(
              `Pág. ${pageNum}: NÃO encontrado nenhum item para "${rawPart}" (qtd ${qty}). ` +
              `Candidatos gerados: ${candidates.join(' | ')}`
            );
          }
        }
      }

      renderTable();
      addLog(
        `\nResumo final: ${movimentosAplicados} movimentações aplicadas, ` +
        `${movimentosNaoEncontrados} não encontradas.\n`
      );
    }

    // ====================== EVENTOS DE UI ======================

    document.getElementById('processBtn').addEventListener('click', async () => {
      const input = document.getElementById('pdfInput');
      const file = input.files && input.files[0];
      if (!file) {
        alert('Selecione um arquivo PDF de etiquetas primeiro.');
        return;
      }
      addLog(`Iniciando leitura do PDF: ${file.name}`);
      await processPdfFile(file);
    });

    document.getElementById('resetStockBtn').addEventListener('click', () => {
      resetStockTo300();
    });

    document.getElementById('addItemBtn').addEventListener('click', () => {
      addNewItem();
    });

    document.getElementById('searchInput').addEventListener('input', (e) => {
      currentFilter = e.target.value || '';
      renderTable();
    });

    document.getElementById('clearSearchBtn').addEventListener('click', () => {
      document.getElementById('searchInput').value = '';
      currentFilter = '';
      renderTable();
    });

    document.getElementById('clearLogBtn').addEventListener('click', () => {
      clearLog();
    });

    // Edição de células (inline) + excluir
    document.getElementById('stockTable').addEventListener('blur', (e) => {
      const cell = e.target;
      if (cell.matches('td[contenteditable="true"]')) {
        const id = Number(cell.getAttribute('data-id'));
        const field = cell.getAttribute('data-field');
        const item = items.find(it => it.id === id);
        if (!item) return;

        let value = cell.textContent.trim();
        if (field === 'estoqueAtual') {
          const num = parseInt(value, 10);
          if (!isNaN(num)) {
            item[field] = num;
          } else {
            item[field] = item[field]; // mantém valor anterior
            cell.textContent = item[field];
          }
        } else {
          item[field] = value;
        }
        rebuildSkuIndex();
        updateSummary();
      }
    }, true);

    document.getElementById('stockTable').addEventListener('click', (e) => {
      const btn = e.target;
      if (btn.matches('button[data-action="delete"]')) {
        const id = Number(btn.getAttribute('data-id'));
        items = items.filter(it => it.id !== id);
        // Reorganiza IDs só para ficar bonitinho
        items.forEach((it, idx) => it.id = idx + 1);
        renderTable();
        addLog(`Item com id ${id} excluído.`);
      }
    });

    // Inicializa a tabela e o índice
    renderTable();
  </script>
</body>
</html>
