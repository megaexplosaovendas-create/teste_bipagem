<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Bipagem - QR + OCR (SKU / Quantidade / Rastreio)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      background: #f7f7f7;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    h1, h2 {
      font-size: 20px;
      margin: 10px 0;
    }
    p {
      margin: 6px 0;
      font-size: 14px;
    }
    input, button {
      font-size: 14px;
      padding: 6px 8px;
      margin: 3px 0;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      border-radius: 6px;
      border: none;
      background: #1976d2;
      color: #fff;
    }
    button.secondary {
      background: #555;
    }
    button:disabled {
      background: #aaa;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
    .row-actions button {
      font-size: 12px;
      padding: 3px 6px;
      background: #c62828;
    }
    .row-actions button.editar {
      background: #f9a825;
      margin-right: 4px;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin: 6px 0;
    }
    .ok    { background: #e0ffe0; }
    .pendente { background: #fffbe0; }
    .alerta   { background: #ffe0e0; }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
    }
    .badge-ok { background: #c6f6c6; }
    .badge-pendente { background: #fff2b3; }
    .badge-alerta { background: #ffc4c4; }

    #reader {
      width: 260px;
      max-width: 100%;
      margin-top: 8px;
    }

    #ocrPreview {
      max-width: 100%;
      max-height: 250px;
      margin-top: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .chip {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #ccc;
      margin: 2px;
      font-size: 11px;
      background: #fafafa;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Controle de Bipagem - Etiqueta Completa (Texto + QR)</h1>

  <p class="small">
    Fluxo pensado pra suas etiquetas Shopee:<br>
    • <b>Leitor OCR da etiqueta inteira</b> → separa linhas tipo <code>1. CS-30 *1</code> e joga no estoque.<br>
    • <b>Leitor de QR code</b> → pega código de rastreio (ex: <code>BR2540...</code>).<br>
    • Estoque inicial vem da planilha <b>Planilha SKU.xlsx</b> (lista de SKUs já embutida no código).
  </p>

  <!-- RESUMO -->
  <div id="resumo"></div>

  <!-- ÁREA DE CONTROLE DE ESTOQUE MANUAL -->
  <h2>1) Adicionar / atualizar / excluir itens manualmente</h2>
  <p class="small">
    Aqui você pode incluir SKUs novos, ajustar quantidade esperada, ou remover linhas.
  </p>
  <div class="toolbar">
    <div style="flex:1; min-width:150px;">
      <label>SKU (planilha)</label><br>
      <input type="text" id="novoSku" placeholder="Ex: D-Y03, KP-RO833, ON-FN632...">
    </div>
    <div style="flex:1; min-width:100px;">
      <label>Cor (planilha)</label><br>
      <input type="text" id="novaCor" placeholder="Ex: PRETO, AZUL, ROSA...">
    </div>
    <div style="width:120px;">
      <label>Quantidade</label><br>
      <input type="number" id="novaQtd" value="300" min="0">
    </div>
    <div>
      <button id="btnAdicionar">Adicionar / Atualizar</button>
    </div>
  </div>

  <!-- TABELA DE ITENS -->
  <h2>2) Itens em estoque (variações SKU + cor)</h2>
  <div style="max-height: 330px; overflow:auto;">
    <table id="tabelaItens">
      <thead>
      <tr>
        <th>#</th>
        <th>SKU (planilha)</th>
        <th>Cor</th>
        <th>SKU p/ bipagem (padrão PDF)</th>
        <th>Qtd esperada</th>
        <th>Bipado</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
      </thead>
      <tbody id="tbodyItens"></tbody>
    </table>
  </div>

  <!-- LEITOR POR CÓDIGO DE BARRAS / QR (html5-qrcode) -->
  <h2>3) Leitura por QR code (rastreio)</h2>
  <p class="small">
    Esse modo lê apenas o <b>QR code</b> da etiqueta para obter o código de rastreio (ex: <code>BR25...</code>).
  </p>
  <div class="toolbar">
    <button id="btnCameraQR">Abrir câmera (QR)</button>
    <button id="btnFecharQR" class="secondary" disabled>Fechar câmera QR</button>
  </div>
  <div id="reader"></div>
  <div id="infoQr" class="small"></div>
  <div id="listaRastreios" class="small"></div>

  <!-- LEITOR DE TEXTO (OCR) PARA ETIQUETA INTEIRA -->
  <h2>4) Ler etiqueta inteira (OCR texto) → SKU + quantidade</h2>
  <p class="small">
    Esse modo tira uma foto da etiqueta, faz OCR e procura linhas no padrão
    <code>1. ALGUM-SKU (COR) *QTD</code>.<br>
    Ele vai extrair o <b>SKU completo</b> e a <b>quantidade</b>, depois descontar do estoque (bipado).
  </p>

  <div class="toolbar">
    <button id="btnCameraOCR">Tirar foto da etiqueta (abrir câmera)</button>
    <input type="file" id="inputOCR" accept="image/*" capture="environment" style="display:none;">
  </div>
  <img id="ocrPreview" alt="" style="display:none;">
  <div id="infoOcr" class="small"></div>

  <!-- LEITOR POR TEXTO (campo manual) -->
  <h2>5) Bipagem direta (campo texto / leitor via teclado)</h2>
  <p class="small">
    Se o leitor de código de barras funcionar como teclado, você pode deixar esse campo focado e apenas bipar.<br>
    Você também pode digitar algo no formato da etiqueta, como:
    <code>1. TE-124 (Iluminação RGB Gamer) *3</code>.
  </p>
  <div class="toolbar">
    <input id="campoBipagem" placeholder="Bipe ou cole linha aqui e pressione Enter">
  </div>
  <div id="infoBipagem" class="small"></div>

  <!-- SOM DE BIP -->
  <audio id="beepAudio">
    <!-- Beep simples gerado via Web Audio (fallback se não tocar nada) -->
  </audio>
</div>

<!-- SCRIPTS EXTERNOS -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
  // ==========================================
  // 0) ESTRUTURA BÁSICA DE DADOS
  // ==========================================
  let itens = []; // {id, sku, cor, qty, bipado}
  let proximoId = 1;
  let rastreios = []; // lista de códigos lidos no QR

  const tbodyItens   = document.getElementById('tbodyItens');
  const resumoDiv    = document.getElementById('resumo');
  const campoBipagem = document.getElementById('campoBipagem');
  const infoBipagem  = document.getElementById('infoBipagem');
  const infoQr       = document.getElementById('infoQr');
  const listaRastreiosDiv = document.getElementById('listaRastreios');
  const infoOcr      = document.getElementById('infoOcr');
  const beepAudio    = document.getElementById('beepAudio');

  // ==========================================
  // 1) LISTA DE ITENS DA PLANILHA
  // (Cole aqui o array itensBasePlanilha inteiro que já usamos antes)
  // ==========================================
  const itensBasePlanilha = [
    // EXEMPLOS. SUBSTITUA por toda a lista que você já tem:
    {"sku": "CS-30", "cor": "", "qty": 300},
    {"sku": "D-3204", "cor": "", "qty": 300},
    {"sku": "D-3205", "cor": "", "qty": 300},
    {"sku": "D-3210", "cor": "", "qty": 300},
    {"sku": "D-4232", "cor": "", "qty": 300},
    {"sku": "D-S3158", "cor": "PRETO", "qty": 300},
    {"sku": "D-S3158", "cor": "VERMELHO", "qty": 300},
    {"sku": "D-Y03", "cor": "CINZA", "qty": 300},
    {"sku": "D-Y03", "cor": "LARANJA", "qty": 300},
    {"sku": "D-Y04", "cor": "", "qty": 300},
    {"sku": "D-Y05", "cor": "", "qty": 300},
    {"sku": "KP-RO826", "cor": "", "qty": 300},
    {"sku": "KP-RO833", "cor": "", "qty": 300},
    {"sku": "KP-RO832", "cor": "", "qty": 300},
    {"sku": "KP-RO852", "cor": "", "qty": 300},
    {"sku": "KP-6040", "cor": "", "qty": 300},
    {"sku": "KP-TE112", "cor": "ROSA", "qty": 300},
    {"sku": "ON-FN632", "cor": "AZUL", "qty": 300},
    {"sku": "ON-FN632", "cor": "ROSA", "qty": 300},
    {"sku": "ON-FN632", "cor": "VERDE", "qty": 300},
    {"sku": "TE-115", "cor": "", "qty": 300},
    {"sku": "TE-124", "cor": "", "qty": 300},
    {"sku": "PG-9023S", "cor": "", "qty": 300},
    {"sku": "XKO01PRETO", "cor": "", "qty": 300},
    // ...
  ];

  function inicializarItens() {
    itens = itensBasePlanilha.map(obj => ({
      id: proximoId++,
      sku: obj.sku,
      cor: obj.cor || "",
      qty: obj.qty || 300,
      bipado: 0
    }));
    renderTabela();
  }

  // ==========================================
  // 2) NORMALIZAÇÃO DE TEXTO / COR
  // ==========================================
  function normalizarTexto(t) {
    if (!t) return "";
    return t.toString().trim().toUpperCase();
  }

  function normalizarCorCanon(cor) {
    if (!cor) return "";
    let c = normalizarTexto(cor);
    c = c
      .replace(/[ÁÀÂÃ]/g, "A")
      .replace(/[ÉÈÊ]/g, "E")
      .replace(/[ÍÌÎ]/g, "I")
      .replace(/[ÓÒÔÕ]/g, "O")
      .replace(/[ÚÙÛ]/g, "U")
      .replace(/Ç/g, "C");
    c = c.replace(/\s+/g, " ");

    const mapa = {
      "BCO": "BRANCO",
      "BRAN": "BRANCO",
      "BRANCO": "BRANCO",
      "PRETA": "PRETO",
      "PRETO": "PRETO",
      "PT": "PRETO",
      "PTO": "PRETO",
      "AZUL": "AZUL",
      "VERDE": "VERDE",
      "VD": "VERDE",
      "ROSA": "ROSA",
      "VERM": "VERMELHO",
      "VERMELHO": "VERMELHO",
      "LARANJA": "LARANJA",
      "CINZA": "CINZA",
      "MARROM": "MARROM",
      "LILAS": "LILAS",
      "ROXO": "ROXO",
      "ROSE": "ROSE",
      "ROSEGOLD": "ROSE"
    };

    const semEspaco = c.replace(/\s+/g, "");
    if (mapa[semEspaco]) return mapa[semEspaco];
    if (mapa[c]) return mapa[c];
    return c;
  }

  function prettyCor(corCanon) {
    if (!corCanon) return "";
    return corCanon.toUpperCase();
  }

  // ==========================================
  // 3) ADAPTAÇÃO DE SKU (planilha -> etiqueta PDF)
  // ==========================================
  function adaptarSkuParaPdf(skuOriginal, corOriginal) {
    if (!skuOriginal) return "";
    const skuUp = normalizarTexto(skuOriginal);
    const corCanon = normalizarCorCanon(corOriginal || "");
    const corPretty = prettyCor(corCanon);

    if (skuUp === "D-3204") {
      return "D-3204+MIC";
    }
    if (skuUp === "D-3210") {
      return "D-3210 (SEM MICROFONE)";
    }
    if (skuUp === "D-3158" || skuUp === "D-S3158") {
      const base = "D-S3158";
      if (corPretty) return base + " (" + corPretty + ")";
      return base;
    }
    if (skuUp === "D-Y03") {
      if (corCanon) return "D-Y03" + corCanon + " (" + corPretty + ")";
      return "D-Y03";
    }
    if (skuUp === "D-Y04" || skuUp === "D-Y05" || skuUp === "D-Y04/05") {
      let base = skuUp;
      if (corPretty) return base + " (" + corPretty + ")";
      return base;
    }
    if (skuUp === "KP-7023") {
      if (corCanon) return "KP-7023" + corCanon + " (" + corPretty + ")";
      return "KP-7023";
    }
    if (skuUp === "ON-FN632" || skuUp === "KP-FN632") {
      if (corCanon) return "ON-FN632" + corCanon + " (" + corPretty + ")";
      return "ON-FN632";
    }
    if (skuUp === "KP-TE115" || skuUp === "TE-115") {
      return "TE-115 (Tecnologia Anti-Ghost)";
    }
    if (skuUp === "KP-TE124" || skuUp === "TE-124") {
      return "TE-124 (Iluminação RGB Gamer)";
    }
    if (skuUp === "KP-TE112") {
      if (corCanon) return "KP-TE112" + corCanon + " (" + corPretty + ")";
      return "KP-TE112";
    }
    if (skuUp === "KP-LB521" || skuUp === "LB-521") {
      return "LB-521";
    }
    if (skuUp === "KP-PN899" || skuUp === "PN-899") {
      return "PN-899PD";
    }
    if (skuUp === "PROT. AURICULAR" || skuUp === "PROT AURICULAR") {
      return "PROTETOR AURICULAR";
    }
    if (skuUp === "D-MN001" || skuUp === "MONITOR D-MN001") {
      return "MONITOR D-MN001";
    }
    if (skuUp === "XKO01PRETO") {
      const corText = corPretty || "PRETO";
      return "XKO01PRETO (" + corText + ")";
    }
    if (skuUp === "CS-30") {
      return "CS-30";
    }
    if (skuUp === "RO-832") {
      return "RO-832";
    }
    if (skuUp === "PG-9023S") {
      return "PG-9023S";
    }
    if (skuUp === "M-303") {
      return "M-303";
    }
    if (skuUp === "FONE" || skuUp === "FONE LEBOSS") {
      return "FONE LEBOSS";
    }

    if (corPretty) {
      return skuUp + " (" + corPretty + ")";
    }
    return skuUp;
  }

  // ==========================================
  // 4) RENDERIZAÇÃO DE TABELA / RESUMO
  // ==========================================
  function renderTabela() {
    tbodyItens.innerHTML = "";

    const ordenados = [...itens].sort((a, b) => {
      const sA = a.sku.toUpperCase();
      const sB = b.sku.toUpperCase();
      if (sA < sB) return -1;
      if (sA > sB) return 1;
      const cA = (a.cor || "").toUpperCase();
      const cB = (b.cor || "").toUpperCase();
      if (cA < cB) return -1;
      if (cA > cB) return 1;
      return 0;
    });

    ordenados.forEach((item, idx) => {
      const tr = document.createElement('tr');
      const bip = item.bipado || 0;
      const esperado = Number(item.qty) || 0;

      let status = "";
      let badgeClass = "";
      let rowClass = "";
      if (esperado === 0 && bip === 0) {
        status = "Sem quantidade";
      } else if (bip === 0 && esperado > 0) {
        status = "Ainda não bipado";
        badgeClass = "badge-pendente";
        rowClass = "pendente";
      } else if (bip < esperado) {
        status = `Pendente (${bip}/${esperado})`;
        badgeClass = "badge-pendente";
        rowClass = "pendente";
      } else if (bip === esperado) {
        status = "OK (completo)";
        badgeClass = "badge-ok";
        rowClass = "ok";
      } else if (bip > esperado) {
        status = `Excesso (${bip}/${esperado})`;
        badgeClass = "badge-alerta";
        rowClass = "alerta";
      }
      tr.className = rowClass;

      const tdIdx = document.createElement('td');
      tdIdx.textContent = idx + 1;
      tr.appendChild(tdIdx);

      const tdSku = document.createElement('td');
      tdSku.textContent = item.sku;
      tr.appendChild(tdSku);

      const tdCor = document.createElement('td');
      tdCor.textContent = item.cor || "-";
      tr.appendChild(tdCor);

      const tdSkuPdf = document.createElement('td');
      tdSkuPdf.textContent = adaptarSkuParaPdf(item.sku, item.cor);
      tr.appendChild(tdSkuPdf);

      const tdQtd = document.createElement('td');
      const inputQtd = document.createElement('input');
      inputQtd.type = "number";
      inputQtd.min = "0";
      inputQtd.value = item.qty;
      inputQtd.style.width = "80px";
      inputQtd.addEventListener('change', () => {
        item.qty = Number(inputQtd.value) || 0;
        renderTabela();
      });
      tdQtd.appendChild(inputQtd);
      tr.appendChild(tdQtd);

      const tdBip = document.createElement('td');
      tdBip.textContent = bip;
      tr.appendChild(tdBip);

      const tdStatus = document.createElement('td');
      if (status) {
        const span = document.createElement('span');
        span.textContent = status;
        span.className = "badge " + badgeClass;
        tdStatus.appendChild(span);
      }
      tr.appendChild(tdStatus);

      const tdAcoes = document.createElement('td');
      tdAcoes.className = "row-actions";

      const btnEditar = document.createElement('button');
      btnEditar.textContent = "Editar";
      btnEditar.className = "editar";
      btnEditar.addEventListener('click', () => {
        document.getElementById('novoSku').value = item.sku;
        document.getElementById('novaCor').value = item.cor;
        document.getElementById('novaQtd').value = item.qty;
      });
      tdAcoes.appendChild(btnEditar);

      const btnRemover = document.createElement('button');
      btnRemover.textContent = "Remover";
      btnRemover.addEventListener('click', () => removerItemPorId(item.id));
      tdAcoes.appendChild(btnRemover);

      tr.appendChild(tdAcoes);

      tbodyItens.appendChild(tr);
    });

    atualizarResumo();
  }

  function atualizarResumo() {
    const totalItens = itens.length;
    const totalQtd = itens.reduce((s, it) => s + (Number(it.qty) || 0), 0);
    const totalBip = itens.reduce((s, it) => s + (Number(it.bipado) || 0), 0);
    resumoDiv.innerHTML =
      `<p><b>Variações cadastradas:</b> ${totalItens}<br>` +
      `<b>Peças esperadas:</b> ${totalQtd}<br>` +
      `<b>Peças bipadas:</b> ${totalBip}</p>`;
  }

  // ==========================================
  // 5) ADICIONAR / ATUALIZAR / REMOVER ITENS
  // ==========================================
  document.getElementById('btnAdicionar').addEventListener('click', function() {
    const sku = document.getElementById('novoSku').value.trim();
    const cor = document.getElementById('novaCor').value.trim();
    const qtd = Number(document.getElementById('novaQtd').value) || 0;

    if (!sku) {
      alert("Informe o SKU.");
      return;
    }
    adicionarOuAtualizarItem(sku, cor, qtd, true);
  });

  function adicionarOuAtualizarItem(sku, cor, qty, renderDepois) {
    const skuNorm = normalizarTexto(sku);
    const corNorm = normalizarTexto(cor);

    let item = itens.find(it =>
      normalizarTexto(it.sku) === skuNorm &&
      normalizarTexto(it.cor) === corNorm
    );

    if (item) {
      item.qty = qty;
    } else {
      itens.push({
        id: proximoId++,
        sku: sku,
        cor: cor,
        qty: qty,
        bipado: 0
      });
    }

    if (renderDepois) {
      renderTabela();
      document.getElementById('novoSku').value = "";
      document.getElementById('novaCor').value = "";
      document.getElementById('novaQtd').value = 300;
    }
  }

  function removerItemPorId(id) {
    itens = itens.filter(it => it.id !== id);
    renderTabela();
  }

  // ==========================================
  // 6) BIPAGEM DIRETA (TEXTO / LEITOR TECLADO)
  // ==========================================
  campoBipagem.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      const valor = campoBipagem.value.trim();
      if (valor) {
        processarLinhaEtiqueta(valor);
        campoBipagem.value = "";
      }
    }
  });

  // Recebe UMA linha tipo "1. CS-30 *3" ou "1. D-Y03LARANJA (LARANJA) *1"
  function processarLinhaEtiqueta(linha) {
    const regex = /^\s*\d+\.\s*(.+?)\s*\*([\d,\.]+)/;
    const m = linha.match(regex);
    if (!m) {
      infoBipagem.textContent = `⚠ Não encontrei padrão "1. SKU *QTD" em: "${linha}"`;
      return;
    }
    const skuEtiqueta = m[1].trim();
    let qtd = m[2].replace(',', '.');
    qtd = parseInt(qtd, 10) || 0;
    if (qtd <= 0) {
      infoBipagem.textContent = `⚠ Quantidade inválida em: "${linha}"`;
      return;
    }

    // Tenta casar SKU da etiqueta com SKU p/ bipagem
    registrarBipagemPorSkuEtiqueta(skuEtiqueta, qtd);
  }

  // Aumenta bipado daquele SKU pela quantidade
  function registrarBipagemPorSkuEtiqueta(skuEtiqueta, quantidade) {
    const etiquetaNorm = normalizarTexto(skuEtiqueta);

    const candidatos = itens.filter(it => {
      const skuPdf = normalizarTexto(adaptarSkuParaPdf(it.sku, it.cor));
      return skuPdf === etiquetaNorm;
    });

    if (candidatos.length === 0) {
      infoBipagem.textContent =
        `⚠ SKU da etiqueta não encontrado na tabela: "${skuEtiqueta}"`;
      return;
    }
    if (candidatos.length > 1) {
      infoBipagem.textContent =
        `⚠ SKU "${skuEtiqueta}" corresponde a mais de um item na tabela. Verifique variações.`;
      return;
    }

    const item = candidatos[0];
    item.bipado = (item.bipado || 0) + quantidade;

    const esperado = Number(item.qty) || 0;
    const bip = item.bipado;

    let msg;
    if (bip > esperado && esperado > 0) {
      msg = `ALERTA: "${skuEtiqueta}" bipado ${bip}x, mas quantidade esperada é ${esperado}.`;
    } else if (bip === esperado && esperado > 0) {
      msg = `OK: "${skuEtiqueta}" atingiu a quantidade completa (${bip}/${esperado}).`;
    } else {
      msg = `PENDENTE: "${skuEtiqueta}" bipado ${bip}/${esperado}.`;
    }
    infoBipagem.textContent = msg;
    tocarBeep();
    renderTabela();
  }

  function tocarBeep() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "square";
      osc.frequency.value = 900;
      gain.gain.value = 0.1;
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      setTimeout(() => {
        osc.stop();
        ctx.close();
      }, 120);
    } catch (e) {
      // se der erro, ignora (sem som)
    }
  }

  // ==========================================
  // 7) LEITOR QR CODE (RASTREIO)
  // ==========================================
  let html5QrCode = null;
  let cameraQrAtiva = false;

  const btnCameraQR = document.getElementById('btnCameraQR');
  const btnFecharQR = document.getElementById('btnFecharQR');

  btnCameraQR.addEventListener('click', async function() {
    if (cameraQrAtiva) return;
    try {
      html5QrCode = new Html5Qrcode("reader");
      infoQr.textContent = "Abrindo câmera para ler QR...";

      await html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 220, height: 220 } },
        (decodedText, decodedResult) => {
          // decodedText é, por ex, "BR2540..."
          registrarQr(decodedText);
        },
        (errorMessage) => {
          // erros de leitura contínuos são normais, não mostra nada
        }
      );
      cameraQrAtiva = true;
      btnCameraQR.disabled = true;
      btnFecharQR.disabled = false;
      infoQr.textContent = "Câmera ativa. Aponte para o QR code da etiqueta.";
    } catch (err) {
      console.error(err);
      infoQr.textContent = "Não foi possível abrir a câmera para QR: " + err;
    }
  });

  btnFecharQR.addEventListener('click', async function() {
    if (html5QrCode && cameraQrAtiva) {
      try {
        await html5QrCode.stop();
        await html5QrCode.clear();
      } catch (e) {
        console.error(e);
      }
    }
    cameraQrAtiva = false;
    btnCameraQR.disabled = false;
    btnFecharQR.disabled = true;
    infoQr.textContent = "Câmera de QR desligada.";
  });

  function registrarQr(texto) {
    const t = texto.trim();
    if (!t) return;

    if (!rastreios.includes(t)) {
      rastreios.push(t);
      tocarBeep();
    }
    infoQr.textContent = `Último QR lido: ${t}`;
    atualizarListaRastreios();
  }

  function atualizarListaRastreios() {
    if (!rastreios.length) {
      listaRastreiosDiv.innerHTML = "";
      return;
    }
    listaRastreiosDiv.innerHTML =
      "<b>Rastreios lidos:</b><br>" +
      rastreios.map(r => `<span class="chip">${r}</span>`).join(" ");
  }

  // ==========================================
  // 8) OCR PARA ETIQUETA INTEIRA (FOTO)
  // ==========================================
  const btnCameraOCR = document.getElementById('btnCameraOCR');
  const inputOCR = document.getElementById('inputOCR');
  const ocrPreview = document.getElementById('ocrPreview');

  btnCameraOCR.addEventListener('click', function() {
    // dispara o input de arquivo (abre câmera no celular)
    inputOCR.click();
  });

  inputOCR.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(evt) {
      const dataUrl = evt.target.result;
      ocrPreview.src = dataUrl;
      ocrPreview.style.display = "block";
      infoOcr.textContent = "Lendo texto da etiqueta (OCR)... isso pode levar alguns segundos.";
      fazerOcrNaImagem(dataUrl);
    };
    reader.readAsDataURL(file);
  });

  async function fazerOcrNaImagem(dataUrl) {
    try {
      const result = await Tesseract.recognize(
        dataUrl,
        'por', // idioma pt
        {
          logger: m => {
            // console.log(m);
          }
        }
      );
      const texto = result.data.text || "";
      infoOcr.textContent = "OCR concluído. Processando linhas de SKU...";

      processarTextoEtiquetaCompleta(texto);
    } catch (err) {
      console.error(err);
      infoOcr.textContent = "Erro ao fazer OCR: " + err;
    }
  }

  function processarTextoEtiquetaCompleta(texto) {
    const linhas = texto.split(/\r?\n/);
    let encontrados = 0;

    for (const linha of linhas) {
      const l = linha.trim();
      if (!l) continue;

      // tenta aplicar o mesmo padrão "1. SKU *QTD"
      const regex = /^\s*\d+\.\s*(.+?)\s*\*([\d,\.]+)/;
      const m = l.match(regex);
      if (!m) continue;

      encontrados++;
      const skuEtiqueta = m[1].trim();
      let qtd = m[2].replace(',', '.');
      qtd = parseInt(qtd, 10) || 0;
      if (qtd <= 0) continue;

      registrarBipagemPorSkuEtiqueta(skuEtiqueta, qtd);
    }

    if (!encontrados) {
      infoOcr.textContent =
        "OCR concluído, mas não encontrei nenhuma linha no formato '1. SKU *QTD'.";
    } else {
      infoOcr.textContent =
        `OCR OK: encontrei ${encontrados} linha(s) de SKU no formato '1. SKU *QTD' e atualizei o estoque.`;
    }
  }

  // ==========================================
  // 9) INICIALIZAÇÃO
  // ==========================================
  inicializarItens();
</script>
</body>
</html>
