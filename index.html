<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Bipagem com OCR – Estoque Inteligente</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body {
  font-family: Arial;
  padding: 15px;
}
video {
  width: 100%;
  border: 1px solid #aaa;
  border-radius: 6px;
}
#resultadoOCR {
  margin-top: 10px;
  padding: 10px;
  background: #f0f0f0;
  font-size: 14px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
td, th {
  border: 1px solid #ddd;
  padding: 6px;
}
</style>
</head>
<body>

<h2>Bipagem com Câmera (OCR)</h2>

<button id="btnCamera">Ligar câmera e ler texto</button>
<br><br>

<video id="video" autoplay playsinline></video>

<div id="resultadoOCR">Nenhum texto detectado ainda...</div>

<hr>

<h2>Estoque</h2>
<table id="tabelaEstoque">
<thead>
<tr>
  <th>SKU</th>
  <th>Cor</th>
  <th>Qtd</th>
  <th>Ações</th>
</tr>
</thead>
<tbody id="estoqueBody"></tbody>
</table>

<h3>Adicionar SKU</h3>
<input id="novoSku" placeholder="Ex: D-3204">
<input id="novaCor" placeholder="Cor">
<input id="novaQtd" type="number" value="300">
<button onclick="adicionarManual()">Adicionar</button>

<script>
// =====================
// ESTOQUE (mock inicial)
// =====================
let estoque = [
  { sku: "D-3204+MIC", cor: "", qtd: 300 },
  { sku: "TE-115 (Tecnologia Anti-Ghost)", cor:"", qtd:300 },
  { sku: "KP-7023BRANCO (BRANCO)", cor:"BRANCO", qtd:300 },
  { sku: "D-Y03CINZA (CINZA)", cor:"CINZA", qtd:300 }
];

function atualizarTabela() {
  const body = document.getElementById("estoqueBody");
  body.innerHTML = "";
  estoque.forEach((p, i)=>{
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.sku}</td>
      <td>${p.cor}</td>
      <td>${p.qtd}</td>
      <td><button onclick="remover(${i})">Remover</button></td>
    `;
    body.appendChild(tr);
  });
}
atualizarTabela();

function adicionarManual(){
  const s = document.getElementById("novoSku").value.trim();
  const c = document.getElementById("novaCor").value.trim();
  const q = parseInt(document.getElementById("novaQtd").value);
  estoque.push({ sku:s, cor:c, qtd:q });
  atualizarTabela();
}

function remover(i){
  estoque.splice(i,1);
  atualizarTabela();
}

// =====================
// CÂMERA + OCR
// =====================
const video = document.getElementById("video");

document.getElementById("btnCamera").onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }});
  video.srcObject = stream;

  processarOCR();
};

async function processarOCR(){
  setInterval(async ()=>{
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);

    const dataURL = canvas.toDataURL("image/png");
    const result = await Tesseract.recognize(dataURL, "por");

    let texto = result.data.text;
    document.getElementById("resultadoOCR").innerText = texto;

    // Captura SKU tipo: D-3204+MIC *1
    const regex = /([A-Z0-9\-+() ]+)\s*\*([0-9]+)/i;
    const match = texto.match(regex);

    if(match){
      const skuLido = match[1].trim();
      const qtdLida = parseInt(match[2]);

      biparProduto(skuLido, qtdLida);
    }
  }, 2500);
}

function biparProduto(sku, qtd){
  let item = estoque.find(p=>p.sku.toUpperCase()===sku.toUpperCase());
  if(item){
    item.qtd -= qtd;
    if(item.qtd < 0) item.qtd = 0;
    atualizarTabela();
    document.getElementById("resultadoOCR").innerText =
      `✔ SKU reconhecido: ${sku}\n✔ Quantidade: ${qtd}\n✔ Estoque atualizado!`;
  } else {
    document.getElementById("resultadoOCR").innerText =
      `⚠ SKU não encontrado: ${sku}`;
  }
}
</script>

</body>
</html>
