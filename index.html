<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Estoque c/ Bipagem + Câmera (OCR)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tesseract para OCR -->
  <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1, h2 {
      font-size: 20px;
      margin: 8px 0;
    }
    p {
      margin: 6px 0;
      font-size: 14px;
    }
    input, button {
      font-size: 14px;
      padding: 6px 8px;
      margin: 3px 0;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f0f0f0;
    }
    button.primario {
      background: #007bff;
      color: #fff;
      border-color: #007bff;
    }
    button.perigo {
      background: #ff4d4f;
      color: #fff;
      border-color: #ff4d4f;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px;
      text-align: left;
    }
    th {
      background: #fafafa;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
    .row-actions button {
      font-size: 12px;
      padding: 3px 6px;
    }
    @media (min-width: 600px) {
      .form-grid {
        display: grid;
        grid-template-columns: 2fr 2fr 1fr auto;
        gap: 6px;
        align-items: center;
      }
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }

    /* Cores de status */
    .ok {
      background: #e0ffe0;
    }
    .pendente {
      background: #fffbe0;
    }
    .alerta {
      background: #ffe0e0;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
    }
    .badge-ok {
      background: #c6f6c6;
    }
    .badge-pendente {
      background: #fff2b3;
    }
    .badge-alerta {
      background: #ffc4c4;
    }

    /* Câmera / preview */
    #cameraArea {
      margin-top: 8px;
      display: none;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 6px;
      background: #fafafa;
    }
    #videoPreview {
      width: 100%;
      max-height: 260px;
      background: #000;
      border-radius: 4px;
    }
    #ocrStatus {
      font-size: 12px;
      margin-top: 4px;
    }
    #ocrUltimoTexto {
      font-size: 11px;
      white-space: pre-wrap;
      margin-top: 4px;
      max-height: 80px;
      overflow-y: auto;
      background: #fff;
      border: 1px dashed #ddd;
      padding: 4px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Estoque + Bipagem c/ Câmera (OCR)</h1>

  <p class="small">
    • Itens vêm “embutidos” no HTML (lista de SKUs).<br>
    • Você bipar por teclado/leitor ou ler o texto da etiqueta pela câmera (OCR).<br>
    • A partir da linha da etiqueta no formato <code>1. SKU COMPLETO *QTD</code>, o sistema pega o SKU e a quantidade.
  </p>

  <h2>1) Adicionar / atualizar / excluir SKU manualmente</h2>
  <div class="form-grid">
    <div>
      <label>SKU (planilha)</label><br>
      <input type="text" id="novoSku" placeholder="Ex: CS-30, D-Y03CINZA (CINZA)...">
    </div>
    <div>
      <label>Cor (opcional)</label><br>
      <input type="text" id="novaCor" placeholder="Ex: PRETO, AZUL, (Vermelho)...">
    </div>
    <div>
      <label>Quantidade inicial</label><br>
      <input type="number" id="novaQtd" value="300" min="0">
    </div>
    <div>
      <button id="btnAdicionar" class="primario">Adicionar / Atualizar</button><br>
      <button id="btnExcluirSku" class="perigo">Excluir SKU</button>
    </div>
  </div>
  <p class="small">
    • “Adicionar / Atualizar”: se o SKU+Cor já existir, só muda a quantidade esperada.<br>
    • “Excluir SKU”: remove totalmente o SKU+Cor da tabela (estoque + bipado).
  </p>

  <div id="resumo"></div>

  <h2>2) Itens carregados</h2>
  <div style="max-height: 320px; overflow: auto;">
    <table id="tabelaItens">
      <thead>
        <tr>
          <th>#</th>
          <th>SKU</th>
          <th>Cor</th>
          <th>Qtd esperada</th>
          <th>Bipado</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyItens"></tbody>
    </table>
  </div>

  <h2>3) Bipagem</h2>
  <p class="small">
    • <b>Leitor / teclado:</b> digite ou bipar o SKU (exatamente como está na coluna “SKU”).<br>
    • <b>Câmera (OCR):</b> aponta para a linha da etiqueta que tenha algo como <code>1. CS-30 *1</code> ou <code>1. D-Y03CINZA (CINZA) *3</code>.<br>
    Ele extrai o SKU e a quantidade após o <code>*</code> e lança no estoque.
  </p>

  <div class="toolbar">
    <button id="btnIniciarBipagem" class="primario">Focar campo de bipagem (teclado)</button>
    <button id="btnCamera" class="primario">Ler com câmera (OCR)</button>
    <button id="btnFecharCamera">Fechar câmera</button>
  </div>

  <input id="campoBipagem" placeholder="Bipe ou digite o SKU aqui (Enter)" />

  <div id="infoBipagem" class="small"></div>

  <div id="cameraArea">
    <video id="videoPreview" autoplay playsinline></video>
    <div id="ocrStatus" class="small">Câmera iniciada. Mire na linha com “1. SKU *QTD”.</div>
    <div class="small"><b>Último texto detectado (OCR):</b></div>
    <div id="ocrUltimoTexto"></div>
  </div>
</div>

<script>
  // =========================
  // 0) Dados base (SUBSTITUIR PELO ARRAY COMPLETO DA SUA PLANILHA)
  // =========================
  // Aqui vão alguns exemplos de SKU. Troque esse array por aquele "itensBasePlanilha"
  // gigante que você já tinha, adaptando para { sku, cor, qty }.
  const itensBasePlanilha = [
    { sku: "CS-30", cor: "", qty: 300 },
    { sku: "D-3204+MIC", cor: "", qty: 300 },
    { sku: "D-3205", cor: "", qty: 300 },
    { sku: "D-3210 (SEM MICROFONE)", cor: "", qty: 300 },
    { sku: "D-4232", cor: "", qty: 300 },
    { sku: "D-G555", cor: "", qty: 300 },
    { sku: "D-S3158 (Preto)", cor: "", qty: 300 },
    { sku: "D-S3158 (Vermelho)", cor: "", qty: 300 },
    { sku: "D-Y03CINZA (CINZA)", cor: "", qty: 300 },
    { sku: "D-Y03LARANJA (LARANJA)", cor: "", qty: 300 },
    { sku: "D-Y04", cor: "", qty: 300 },
    { sku: "D-Y05", cor: "", qty: 300 },
    { sku: "KP-RO826 (Azul)", cor: "", qty: 300 },
    { sku: "KP-7023BRANCO (BRANCO)", cor: "", qty: 300 },
    { sku: "TE-115 (Tecnologia Anti-Ghost)", cor: "", qty: 300 },
    { sku: "TE115+FONE LEBOSS", cor: "", qty: 300 },
    { sku: "TE-124 (Iluminação RGB Gamer)", cor: "", qty: 300 },
    { sku: "XKO01PRETO (Preto)", cor: "", qty: 300 }
    // ... aqui você cola TODOS os SKUs completos que quiser controlar
  ];

  // =========================
  // 1) Estrutura interna
  // =========================
  let itens = []; // {id, sku, cor, qty, bipado}
  let proximoId = 1;

  const tbodyItens = document.getElementById('tbodyItens');
  const resumoDiv = document.getElementById('resumo');
  const campoBipagem = document.getElementById('campoBipagem');
  const infoBipagem = document.getElementById('infoBipagem');

  const btnAdicionar = document.getElementById('btnAdicionar');
  const btnExcluirSku = document.getElementById('btnExcluirSku');
  const btnIniciarBipagem = document.getElementById('btnIniciarBipagem');

  const btnCamera = document.getElementById('btnCamera');
  const btnFecharCamera = document.getElementById('btnFecharCamera');
  const cameraArea = document.getElementById('cameraArea');
  const videoPreview = document.getElementById('videoPreview');
  const ocrStatus = document.getElementById('ocrStatus');
  const ocrUltimoTexto = document.getElementById('ocrUltimoTexto');

  let mediaStream = null;
  let ocrRodando = false;

  // =========================
  // 2) Beep (som)
  // =========================
  function tocarBeep() {
    try {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.type = 'square';
      osc.frequency.value = 1200; // Hz
      osc.connect(gain);
      gain.connect(ctx.destination);
      gain.gain.value = 0.1;

      osc.start();

      gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.1);
      osc.stop(ctx.currentTime + 0.11);
    } catch (e) {
      console.warn("Não foi possível tocar beep:", e);
    }
  }

  // =========================
  // 3) Inicialização dos itens
  // =========================
  function inicializarItens() {
    itens = itensBasePlanilha.map(obj => ({
      id: proximoId++,
      sku: obj.sku,
      cor: obj.cor || "",
      qty: Number(obj.qty) || 0,
      bipado: 0
    }));
    renderTabela();
  }

  function normalizarTexto(txt) {
    return (txt || "").toString().trim().toUpperCase();
  }

  // =========================
  // 4) Renderizar tabela
  // =========================
  function renderTabela() {
    tbodyItens.innerHTML = "";

    const ordenados = [...itens].sort((a, b) => {
      const sA = normalizarTexto(a.sku);
      const sB = normalizarTexto(b.sku);
      if (sA < sB) return -1;
      if (sA > sB) return 1;
      const cA = normalizarTexto(a.cor);
      const cB = normalizarTexto(b.cor);
      if (cA < cB) return -1;
      if (cA > cB) return 1;
      return 0;
    });

    ordenados.forEach((item, index) => {
      const tr = document.createElement('tr');

      const esperado = Number(item.qty) || 0;
      const bip = Number(item.bipado) || 0;

      let status = "";
      let badgeClass = "";
      let rowClass = "";

      if (esperado === 0 && bip === 0) {
        status = "Sem quantidade";
      } else if (bip === 0 && esperado > 0) {
        status = "Ainda não bipado";
        badgeClass = "badge-pendente";
        rowClass = "pendente";
      } else if (bip < esperado) {
        status = `Pendente (${bip}/${esperado})`;
        badgeClass = "badge-pendente";
        rowClass = "pendente";
      } else if (bip === esperado) {
        status = "OK (completo)";
        badgeClass = "badge-ok";
        rowClass = "ok";
      } else if (bip > esperado) {
        status = `Excesso (${bip}/${esperado})`;
        badgeClass = "badge-alerta";
        rowClass = "alerta";
      }

      tr.className = rowClass;

      // #
      const tdIdx = document.createElement('td');
      tdIdx.textContent = index + 1;
      tr.appendChild(tdIdx);

      // SKU
      const tdSku = document.createElement('td');
      tdSku.textContent = item.sku;
      tr.appendChild(tdSku);

      // Cor
      const tdCor = document.createElement('td');
      tdCor.textContent = item.cor || "-";
      tr.appendChild(tdCor);

      // Quantidade (editável)
      const tdQtd = document.createElement('td');
      const inputQtd = document.createElement('input');
      inputQtd.type = "number";
      inputQtd.min = "0";
      inputQtd.value = item.qty;
      inputQtd.style.width = "80px";
      inputQtd.addEventListener('change', () => {
        item.qty = Number(inputQtd.value) || 0;
        renderTabela();
      });
      tdQtd.appendChild(inputQtd);
      tr.appendChild(tdQtd);

      // Bipado
      const tdBip = document.createElement('td');
      tdBip.textContent = bip;
      tr.appendChild(tdBip);

      // Status
      const tdStatus = document.createElement('td');
      if (status) {
        const span = document.createElement('span');
        span.textContent = status;
        span.className = "badge " + badgeClass;
        tdStatus.appendChild(span);
      }
      tr.appendChild(tdStatus);

      // Ações
      const tdAcoes = document.createElement('td');
      tdAcoes.className = "row-actions";
      const btnReset = document.createElement('button');
      btnReset.textContent = "Zerar bipado";
      btnReset.addEventListener('click', () => {
        item.bipado = 0;
        renderTabela();
      });
      tdAcoes.appendChild(btnReset);

      tbodyItens.appendChild(tr);
    });

    atualizarResumo();
  }

  function atualizarResumo() {
    const totalItens = itens.length;
    const totalQtd = itens.reduce((s, it) => s + (Number(it.qty) || 0), 0);
    const totalBip = itens.reduce((s, it) => s + (Number(it.bipado) || 0), 0);

    resumoDiv.innerHTML =
      `<p><b>Total de SKUs/variações:</b> ${totalItens}<br>` +
      `<b>Total de peças esperadas:</b> ${totalQtd}<br>` +
      `<b>Total de peças bipadas:</b> ${totalBip}</p>`;
  }

  // =========================
  // 5) Adicionar / Atualizar / Excluir SKU
  // =========================
  btnAdicionar.addEventListener('click', () => {
    const sku = document.getElementById('novoSku').value.trim();
    const cor = document.getElementById('novaCor').value.trim();
    const qtd = Number(document.getElementById('novaQtd').value) || 0;

    if (!sku) {
      alert("Informe o SKU.");
      return;
    }
    adicionarOuAtualizarItem(sku, cor, qtd, true);
  });

  btnExcluirSku.addEventListener('click', () => {
    const sku = document.getElementById('novoSku').value.trim();
    const cor = document.getElementById('novaCor').value.trim();

    if (!sku) {
      alert("Informe o SKU para excluir.");
      return;
    }

    const skuNorm = normalizarTexto(sku);
    const corNorm = normalizarTexto(cor);

    const antes = itens.length;
    itens = itens.filter(it =>
      normalizarTexto(it.sku) !== skuNorm ||
      normalizarTexto(it.cor) !== corNorm
    );
    const depois = itens.length;

    if (depois < antes) {
      infoBipagem.textContent = `SKU "${sku}" (${cor || "-"}) removido.`;
      tocarBeep();
      renderTabela();
    } else {
      infoBipagem.textContent = `SKU "${sku}" (${cor || "-"}) não encontrado para remoção.`;
    }
  });

  function adicionarOuAtualizarItem(sku, cor, qty, limparCampos) {
    const skuNorm = normalizarTexto(sku);
    const corNorm = normalizarTexto(cor);

    let item = itens.find(it =>
      normalizarTexto(it.sku) === skuNorm &&
      normalizarTexto(it.cor) === corNorm
    );

    if (item) {
      item.qty = qty;
      infoBipagem.textContent = `SKU "${sku}" (${cor || "-"}) atualizado para quantidade ${qty}.`;
    } else {
      itens.push({
        id: proximoId++,
        sku,
        cor,
        qty,
        bipado: 0
      });
      infoBipagem.textContent = `SKU "${sku}" (${cor || "-"}) adicionado com quantidade ${qty}.`;
    }

    tocarBeep();
    renderTabela();

    if (limparCampos) {
      document.getElementById('novoSku').value = "";
      document.getElementById('novaCor').value = "";
      document.getElementById('novaQtd').value = 300;
    }
  }

  // =========================
  // 6) Bipagem por teclado / leitor
  // =========================
  btnIniciarBipagem.addEventListener('click', () => {
    campoBipagem.focus();
  });

  campoBipagem.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const valor = campoBipagem.value.trim();
      if (valor) {
        registrarBipagem(valor, 1); // padrão: 1 peça
        campoBipagem.value = "";
      }
    }
  });

  function registrarBipagem(skuLido, qtdLida) {
    const skuNorm = normalizarTexto(skuLido);
    const quantidade = Number(qtdLida) || 1;

    const candidatos = itens.filter(it => normalizarTexto(it.sku) === skuNorm);

    if (candidatos.length === 0) {
      infoBipagem.textContent = `⚠ SKU "${skuLido}" não encontrado na tabela.`;
      return;
    }
    if (candidatos.length > 1) {
      infoBipagem.textContent = `⚠ SKU "${skuLido}" corresponde a mais de uma linha (variação). Especifique melhor.`;
      return;
    }

    const item = candidatos[0];
    item.bipado = (Number(item.bipado) || 0) + quantidade;
    tocarBeep();

    const esperado = Number(item.qty) || 0;
    const bip = item.bipado;
    let msg = `"${item.sku}" lançado +${quantidade}. Agora: ${bip}/${esperado}.`;
    if (esperado > 0) {
      if (bip === esperado) msg += " ✅ Completo.";
      else if (bip > esperado) msg += " ⚠ EXCESSO.";
    }
    infoBipagem.textContent = msg;
    renderTabela();
  }

  // =========================
  // 7) Câmera + OCR
  // =========================
  btnCamera.addEventListener('click', iniciarCameraEOcr);
  btnFecharCamera.addEventListener('click', pararCameraEOcr);

  async function iniciarCameraEOcr() {
    if (ocrRodando) {
      cameraArea.style.display = 'block';
      ocrStatus.textContent = "Câmera já ativa. Mire na linha da etiqueta.";
      return;
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment'
        }
      });
      mediaStream = stream;
      videoPreview.srcObject = stream;
      cameraArea.style.display = 'block';
      ocrStatus.textContent = "Câmera ativa. Lendo periodicamente...";

      ocrRodando = true;
      loopOcr();
    } catch (e) {
      console.error(e);
      ocrStatus.textContent = "Não foi possível acessar a câmera: " + e;
      cameraArea.style.display = 'none';
      ocrRodando = false;
    }
  }

  async function pararCameraEOcr() {
    if (mediaStream) {
      mediaStream.getTracks().forEach(t => t.stop());
      mediaStream = null;
    }
    ocrRodando = false;
    cameraArea.style.display = 'none';
    ocrStatus.textContent = "Câmera desligada.";
  }

  async function loopOcr() {
    while (ocrRodando) {
      const frameText = await capturarTextoFrame();
      if (frameText) {
        ocrUltimoTexto.textContent = frameText;
        // tenta achar linha com padrão 1. SKU *QTD
        const { sku, qtd } = extrairSkuEQuantidade(frameText);
        if (sku) {
          registrarBipagem(sku, qtd);
        }
      }
      // espera um pouco antes da próxima leitura
      await esperar(2000);
    }
  }

  function esperar(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function capturarTextoFrame() {
    if (!videoPreview.videoWidth || !videoPreview.videoHeight) {
      return "";
    }
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    canvas.width = videoPreview.videoWidth;
    canvas.height = videoPreview.videoHeight;

    // desenha frame atual
    ctx.drawImage(videoPreview, 0, 0, canvas.width, canvas.height);

    // OCR usando Tesseract
    try {
      ocrStatus.textContent = "Lendo texto da imagem...";
      const { data: { text } } = await Tesseract.recognize(
        canvas.toDataURL('image/png'),
        'por', // pode alternar 'eng'/'por' conforme melhor resultado
        { logger: m => {} }
      );
      ocrStatus.textContent = "Texto lido. Procurando linha com SKU...";
      return text;
    } catch (e) {
      console.error("Erro OCR:", e);
      ocrStatus.textContent = "Erro ao ler texto (OCR).";
      return "";
    }
  }

  // Procura padrão: "1. QUALQUER COISA *QTD"
  function extrairSkuEQuantidade(texto) {
    if (!texto) return { sku: null, qtd: 1 };

    const linhas = texto.split(/\r?\n/);
    for (const linha of linhas) {
      // limpa espaços excessivos
      const l = linha.replace(/\s+/g, ' ').trim();
      // regex: começa com "1." ou similar, pega tudo até "*n"
      // Exemplo: "1. D-Y03LARANJA (LARANJA) *3"
      const m = l.match(/^1\.?\s*(.+?)\s*\*+(\d+)\s*$/i);
      if (m) {
        const sku = m[1].trim();   // tudo entre "1." e "*"
        const qtd = parseInt(m[2], 10) || 1;
        return { sku, qtd };
      }
    }
    return { sku: null, qtd: 1 };
  }

  // =========================
  // 8) Inicializar
  // =========================
  inicializarItens();
</script>
</body>
</html>
